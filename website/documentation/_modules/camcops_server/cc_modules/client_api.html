
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>camcops_server.cc_modules.client_api &#8212; CamCOPS 2.2.4 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/camcops_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for camcops_server.cc_modules.client_api</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># camcops_server/client_api.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2012-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CamCOPS.</span>

<span class="sd">    CamCOPS is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CamCOPS is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CamCOPS. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>

<span class="sd">We use primarily SQLAlchemy Core here (in contrast to the ORM used elsewhere).</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Imports</span>
<span class="c1"># =============================================================================</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># from pprint import pformat</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="p">(</span><span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span>
                    <span class="n">TYPE_CHECKING</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.convert</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">base64_64format_encode</span><span class="p">,</span>
    <span class="n">hex_xformat_encode</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.datetimefunc</span> <span class="k">import</span> <span class="n">coerce_to_pendulum</span><span class="p">,</span> <span class="n">format_datetime</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">BraceStyleAdapter</span><span class="p">,</span>
    <span class="n">main_only_quicksetup_rootlogger</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.pyramid.responses</span> <span class="k">import</span> <span class="n">TextResponse</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sql.literals</span> <span class="k">import</span> <span class="n">sql_quote_string</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.core_query</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">exists_in_table</span><span class="p">,</span>
    <span class="n">fetch_all_first_values</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.text</span> <span class="k">import</span> <span class="n">escape_newlines</span><span class="p">,</span> <span class="n">unescape_newlines</span>
<span class="kn">from</span> <span class="nn">pendulum</span> <span class="k">import</span> <span class="n">DateTime</span> <span class="k">as</span> <span class="n">Pendulum</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="k">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">pyramid.response</span> <span class="k">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">pyramid.security</span> <span class="k">import</span> <span class="n">NO_PERMISSION_REQUIRED</span>
<span class="kn">from</span> <span class="nn">semantic_version</span> <span class="k">import</span> <span class="n">Version</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.result</span> <span class="k">import</span> <span class="n">ResultProxy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">IntegrityError</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">exists</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">update</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.schema</span> <span class="k">import</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">camcops_server.cc_modules</span> <span class="k">import</span> <span class="n">cc_audit</span>  <span class="c1"># avoids &quot;audit&quot; name clash</span>
<span class="kn">from</span> <span class="nn">.cc_all_models</span> <span class="k">import</span> <span class="n">CLIENT_TABLE_MAP</span><span class="p">,</span> <span class="n">RESERVED_FIELDS</span>
<span class="kn">from</span> <span class="nn">.cc_blob</span> <span class="k">import</span> <span class="n">Blob</span>
<span class="kn">from</span> <span class="nn">.cc_cache</span> <span class="k">import</span> <span class="n">cache_region_static</span><span class="p">,</span> <span class="n">fkg</span>
<span class="kn">from</span> <span class="nn">.cc_client_api_core</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AllowedTablesFieldNames</span><span class="p">,</span>
    <span class="n">exception_description</span><span class="p">,</span>
    <span class="n">ExtraStringFieldNames</span><span class="p">,</span>
    <span class="n">fail_server_error</span><span class="p">,</span>
    <span class="n">fail_unsupported_operation</span><span class="p">,</span>
    <span class="n">fail_user_error</span><span class="p">,</span>
    <span class="n">IgnoringAntiqueTableException</span><span class="p">,</span>
    <span class="n">require_keys</span><span class="p">,</span>
    <span class="n">ServerErrorException</span><span class="p">,</span>
    <span class="n">TabletParam</span><span class="p">,</span>
    <span class="n">UserErrorException</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_constants</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">CLIENT_DATE_FIELD</span><span class="p">,</span>
    <span class="n">DateFormat</span><span class="p">,</span>
    <span class="n">ERA_NOW</span><span class="p">,</span>
    <span class="n">FP_ID_NUM</span><span class="p">,</span>
    <span class="n">FP_ID_DESC</span><span class="p">,</span>
    <span class="n">FP_ID_SHORT_DESC</span><span class="p">,</span>
    <span class="n">MOVE_OFF_TABLET_FIELD</span><span class="p">,</span>
    <span class="n">NUMBER_OF_IDNUMS_DEFUNCT</span><span class="p">,</span>  <span class="c1"># allowed; for old tablet versions</span>
    <span class="n">TABLET_ID_FIELD</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.cc_convert</span> <span class="k">import</span> <span class="n">decode_values</span><span class="p">,</span> <span class="n">encode_single_value</span>
<span class="kn">from</span> <span class="nn">.cc_device</span> <span class="k">import</span> <span class="n">Device</span>
<span class="kn">from</span> <span class="nn">.cc_dirtytables</span> <span class="k">import</span> <span class="n">DirtyTable</span>
<span class="kn">from</span> <span class="nn">.cc_group</span> <span class="k">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">.cc_patient</span> <span class="k">import</span> <span class="n">Patient</span>
<span class="kn">from</span> <span class="nn">.cc_patientidnum</span> <span class="k">import</span> <span class="n">fake_tablet_id_for_patientidnum</span><span class="p">,</span> <span class="n">PatientIdNum</span>
<span class="kn">from</span> <span class="nn">.cc_pyramid</span> <span class="k">import</span> <span class="n">Routes</span>
<span class="kn">from</span> <span class="nn">.cc_request</span> <span class="k">import</span> <span class="n">CamcopsRequest</span>
<span class="kn">from</span> <span class="nn">.cc_specialnote</span> <span class="k">import</span> <span class="n">SpecialNote</span>
<span class="kn">from</span> <span class="nn">.cc_task</span> <span class="k">import</span> <span class="n">all_task_tables_with_min_client_version</span>
<span class="kn">from</span> <span class="nn">.cc_unittest</span> <span class="k">import</span> <span class="n">DemoDatabaseTestCase</span>
<span class="kn">from</span> <span class="nn">.cc_version</span> <span class="k">import</span> <span class="n">CAMCOPS_SERVER_VERSION_STRING</span><span class="p">,</span> <span class="n">MINIMUM_TABLET_VERSION</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyramid.request</span> <span class="k">import</span> <span class="n">Request</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">BraceStyleAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">))</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">COPE_WITH_DELETED_PATIENT_DESCRIPTIONS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># ... as of client 2.0.0, ID descriptions are no longer duplicated.</span>
<span class="c1"># As of server 2.0.0, the fields still exist in the database, but the reporting</span>
<span class="c1"># and consistency check has been removed. In the next version of the server,</span>
<span class="c1"># the fields will be removed, and then the server should cope with old clients,</span>
<span class="c1"># at least for a while.</span>

<span class="n">DUPLICATE_FAILED</span> <span class="o">=</span> <span class="s2">&quot;Failed to duplicate record&quot;</span>
<span class="n">INSERT_FAILED</span> <span class="o">=</span> <span class="s2">&quot;Failed to insert record&quot;</span>

<span class="c1"># REGEX_INVALID_TABLE_FIELD_CHARS = re.compile(&quot;[^a-zA-Z0-9_]&quot;)</span>
<span class="c1"># ... the ^ within the [] means the expression will match any character NOT in</span>
<span class="c1"># the specified range</span>

<span class="n">DEVICE_STORED_VAR_TABLENAME_DEFUNCT</span> <span class="o">=</span> <span class="s2">&quot;storedvars&quot;</span>
<span class="c1"># ... old table, no longer in use, that Titanium clients used to upload.</span>
<span class="c1"># We recognize and ignore it now so that old clients can still work.</span>

<span class="n">SILENTLY_IGNORE_TABLENAMES</span> <span class="o">=</span> <span class="p">[</span><span class="n">DEVICE_STORED_VAR_TABLENAME_DEFUNCT</span><span class="p">]</span>

<span class="n">IGNORING_ANTIQUE_TABLE_MESSAGE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Ignoring user request to upload antique/defunct table, but reporting &quot;</span>
    <span class="s2">&quot;success to the client&quot;</span>
<span class="p">)</span>

<span class="n">SUCCESS_CODE</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
<span class="n">FAILURE_CODE</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Cached information</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@cache_region_static</span><span class="o">.</span><span class="n">cache_on_arguments</span><span class="p">(</span><span class="n">function_key_generator</span><span class="o">=</span><span class="n">fkg</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">all_tables_with_min_client_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Version</span><span class="p">]:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">all_task_tables_with_min_client_version</span><span class="p">()</span>
    <span class="n">d</span><span class="p">[</span><span class="n">Blob</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINIMUM_TABLET_VERSION</span>
    <span class="n">d</span><span class="p">[</span><span class="n">Patient</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINIMUM_TABLET_VERSION</span>
    <span class="n">d</span><span class="p">[</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINIMUM_TABLET_VERSION</span>
    <span class="c1"># log.critical(&quot;{}&quot;, pformat(d))</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Validators</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="ensure_valid_table_name"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.ensure_valid_table_name">[docs]</a><span class="k">def</span> <span class="nf">ensure_valid_table_name</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures a table name doesn&#39;t contain bad characters, isn&#39;t a reserved</span>
<span class="sd">    table that the user is prohibited from accessing, and is a valid table name</span>
<span class="sd">    that&#39;s in the database. Raises UserErrorException upon failure.</span>

<span class="sd">    ... 2017-10-08: shortcut to all that: it&#39;s OK if it&#39;s listed as a valid</span>
<span class="sd">    client table.</span>
<span class="sd">    ... 2018-01-16 (v2.2.0): check also that client version is OK</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tablename</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CLIENT_TABLE_MAP</span><span class="p">:</span>
        <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Invalid client table name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
    <span class="n">tables_versions</span> <span class="o">=</span> <span class="n">all_tables_with_min_client_version</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">tables_versions</span>
    <span class="n">client_version</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">tablet_version_ver</span>
    <span class="n">minimum_client_version</span> <span class="o">=</span> <span class="n">tables_versions</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">client_version</span> <span class="o">&lt;</span> <span class="n">minimum_client_version</span><span class="p">:</span>
        <span class="n">fail_user_error</span><span class="p">(</span>
            <span class="s2">&quot;Client CamCOPS version </span><span class="si">{cv}</span><span class="s2"> is less than the version (</span><span class="si">{minver}</span><span class="s2">) &quot;</span>
            <span class="s2">&quot;required to handle table </span><span class="si">{t}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">cv</span><span class="o">=</span><span class="n">client_version</span><span class="p">,</span>
                <span class="n">minver</span><span class="o">=</span><span class="n">minimum_client_version</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">tablename</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ensure_valid_field_name"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.ensure_valid_field_name">[docs]</a><span class="k">def</span> <span class="nf">ensure_valid_field_name</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures a field name contains only valid characters, and isn&#39;t a</span>
<span class="sd">    reserved fieldname that the user isn&#39;t allowed to access.</span>
<span class="sd">    Raises UserErrorException upon failure.</span>

<span class="sd">    ... 2017-10-08: shortcut: it&#39;s OK if it&#39;s a column name for a particular</span>
<span class="sd">    table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if fieldname in RESERVED_FIELDS:</span>
    <span class="k">if</span> <span class="n">fieldname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>  <span class="c1"># all reserved fields start with _</span>
        <span class="c1"># ... but not all fields starting with &quot;_&quot; are reserved; e.g.</span>
        <span class="c1"># &quot;_move_off_tablet&quot; is allowed.</span>
        <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">RESERVED_FIELDS</span><span class="p">:</span>
            <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Reserved field name for table </span><span class="si">{!r}</span><span class="s2">: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">fieldname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Invalid field name for table </span><span class="si">{!r}</span><span class="s2">: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">))</span></div>
    <span class="c1"># Note that the reserved-field check is case-sensitive, but so is the</span>
    <span class="c1"># &quot;present in table&quot; check. So for a malicious uploader trying to use, for</span>
    <span class="c1"># example, &quot;_PK&quot;, this would not be picked up as a reserved field (so would</span>
    <span class="c1"># pass that check) but then wouldn&#39;t be recognized as a valid field (so</span>
    <span class="c1"># would fail).</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Extracting information from the POST request</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_str_var"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_str_var">[docs]</a><span class="k">def</span> <span class="nf">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a string variable from CamcopsRequest, raising an error that gets</span>
<span class="sd">    passed to the client device if it&#39;s mandatory and missing.</span>

<span class="sd">    Args:</span>
<span class="sd">        req: CamcopsRequest</span>
<span class="sd">        var: name of variable to retrieve</span>
<span class="sd">        mandatory: if True, script aborts if variable missing</span>
<span class="sd">    Returns:</span>
<span class="sd">        value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_str_param</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mandatory</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Must provide the variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">val</span></div>


<span class="k">def</span> <span class="nf">get_int_var</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mandatory</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Variable </span><span class="si">{}</span><span class="s2"> is not a valid integer; was </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>


<div class="viewcode-block" id="get_table_from_req"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_table_from_req">[docs]</a><span class="k">def</span> <span class="nf">get_table_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a table name from a CGI form and checks it&#39;s a valid client</span>
<span class="sd">    table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tablename</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tablename</span> <span class="ow">in</span> <span class="n">SILENTLY_IGNORE_TABLENAMES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">IgnoringAntiqueTableException</span><span class="p">(</span>
            <span class="s2">&quot;Ignoring table </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="p">))</span>
    <span class="n">ensure_valid_table_name</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tablename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CLIENT_TABLE_MAP</span><span class="p">[</span><span class="n">tablename</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_tables_from_post_var"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_tables_from_post_var">[docs]</a><span class="k">def</span> <span class="nf">get_tables_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                             <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Table</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a list of tables from a CGI form variable, and ensures all are</span>
<span class="sd">    valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cstables</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="n">mandatory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cstables</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># can&#39;t have any commas in table names, so it&#39;s OK to use a simple</span>
    <span class="c1"># split() command</span>
    <span class="n">tablenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cstables</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[Table]</span>
    <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">tablenames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">SILENTLY_IGNORE_TABLENAMES</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">IGNORING_ANTIQUE_TABLE_MESSAGE</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ensure_valid_table_name</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">tn</span><span class="p">)</span>
        <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CLIENT_TABLE_MAP</span><span class="p">[</span><span class="n">tn</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tables</span></div>


<div class="viewcode-block" id="get_single_field_from_post_var"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_single_field_from_post_var">[docs]</a><span class="k">def</span> <span class="nf">get_single_field_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                   <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                                   <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a field name from a the request and checks it&#39;s not a bad</span>
<span class="sd">    fieldname.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="n">mandatory</span><span class="p">)</span>
    <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">field</span></div>


<div class="viewcode-block" id="get_fields_from_post_var"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_fields_from_post_var">[docs]</a><span class="k">def</span> <span class="nf">get_fields_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                             <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                             <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a comma-separated list of field names from a request and checks that</span>
<span class="sd">    all are acceptable. Returns a list of fieldnames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csfields</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="n">mandatory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">csfields</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># can&#39;t have any commas in fields, so it&#39;s OK to use a simple</span>
    <span class="c1"># split() command</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">csfields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
        <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fields</span></div>


<div class="viewcode-block" id="get_values_from_post_var"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_values_from_post_var">[docs]</a><span class="k">def</span> <span class="nf">get_values_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                             <span class="n">var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves a list of values from a CSV-separated list of SQL values</span>
<span class="sd">    stored in a CGI form (including e.g. NULL, numbers, quoted strings, and</span>
<span class="sd">    special handling for base-64/hex-encoded BLOBs.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">csvalues</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="n">mandatory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">csvalues</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">decode_values</span><span class="p">(</span><span class="n">csvalues</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_fields_and_values"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_fields_and_values">[docs]</a><span class="k">def</span> <span class="nf">get_fields_and_values</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                          <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                          <span class="n">fields_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">values_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">mandatory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets fieldnames and matching values from two variables in a request.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">get_fields_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">fields_var</span><span class="p">,</span>
                                      <span class="n">mandatory</span><span class="o">=</span><span class="n">mandatory</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">get_values_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">values_var</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="n">mandatory</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
        <span class="n">fail_user_error</span><span class="p">(</span>
            <span class="s2">&quot;Number of fields (</span><span class="si">{f}</span><span class="s2">) doesn&#39;t match number of values &quot;</span>
            <span class="s2">&quot;(</span><span class="si">{v}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="n">v</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="p">)))</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Sending stuff to the client</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_server_id_info"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_server_id_info">[docs]</a><span class="k">def</span> <span class="nf">get_server_id_info</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Returns a reply for the tablet giving details of the server.&quot;&quot;&quot;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">get_group_by_id</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">upload_group_id</span><span class="p">)</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">DATABASE_TITLE</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">database_title</span><span class="p">,</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">ID_POLICY_UPLOAD</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">upload_policy</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">ID_POLICY_FINALIZE</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">finalize_policy</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">SERVER_CAMCOPS_VERSION</span><span class="p">:</span> <span class="n">CAMCOPS_SERVER_VERSION_STRING</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">valid_which_idnums</span><span class="p">:</span>
        <span class="n">nstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">reply</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">ID_DESCRIPTION_PREFIX</span> <span class="o">+</span> <span class="n">nstr</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">req</span><span class="o">.</span><span class="n">get_id_desc</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">reply</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">ID_SHORT_DESCRIPTION_PREFIX</span> <span class="o">+</span> <span class="n">nstr</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">req</span><span class="o">.</span><span class="n">get_id_shortdesc</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reply</span></div>


<div class="viewcode-block" id="get_select_reply"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_select_reply">[docs]</a><span class="k">def</span> <span class="nf">get_select_reply</span><span class="p">(</span><span class="n">fields</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                     <span class="n">rows</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return format:</span>

<span class="sd">    .. code-block:: none</span>

<span class="sd">        nfields:X</span>
<span class="sd">        fields:X</span>
<span class="sd">        nrecords:X</span>
<span class="sd">        record0:VALUES_AS_CSV_LIST_OF_ENCODED_SQL_VALUES</span>
<span class="sd">            ...</span>
<span class="sd">        record{n}:VALUES_AS_CSV_LIST_OF_ENCODED_SQL_VALUES</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrecords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">NFIELDS</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span>
        <span class="n">TabletParam</span><span class="o">.</span><span class="n">NRECORDS</span><span class="p">:</span> <span class="n">nrecords</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrecords</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">encodedvalues</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">encodedvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encode_single_value</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="n">reply</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">RECORD_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">encodedvalues</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reply</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># CamCOPS table functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_server_pks_of_active_records"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_server_pks_of_active_records">[docs]</a><span class="k">def</span> <span class="nf">get_server_pks_of_active_records</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                     <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets server PKs of active records (_current and in the &#39;NOW&#39; era) for</span>
<span class="sd">    the specified device/table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span><span class="p">])</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fetch_all_first_values</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="record_exists"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.record_exists">[docs]</a><span class="k">def</span> <span class="nf">record_exists</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                  <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                  <span class="n">clientpk_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">clientpk_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if a record exists, using the device&#39;s perspective of a</span>
<span class="sd">    table/client PK combination.</span>
<span class="sd">    Returns (exists, serverpk), where exists is Boolean.</span>
<span class="sd">    If exists is False, serverpk will be None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log.critical(&quot;record_exists: checking table={}, {}={}&quot;,</span>
    <span class="c1">#              table.name, clientpk_name, clientpk_value)</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span><span class="p">])</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">clientpk_name</span><span class="p">]</span> <span class="o">==</span> <span class="n">clientpk_value</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pklist</span> <span class="o">=</span> <span class="n">fetch_all_first_values</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="n">rec_exists</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pklist</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">serverpk</span> <span class="o">=</span> <span class="n">pklist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">rec_exists</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">rec_exists</span><span class="p">,</span> <span class="n">serverpk</span></div>
    <span class="c1"># Consider a warning/failure if we have &gt;1 row meeting these criteria.</span>
    <span class="c1"># Not currently checked for.</span>


<div class="viewcode-block" id="client_pks_that_exist"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.client_pks_that_exist">[docs]</a><span class="k">def</span> <span class="nf">client_pks_that_exist</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                          <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                          <span class="n">clientpk_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                          <span class="n">clientpk_values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Searches for client PK values (for this device, current, and &#39;now&#39;)</span>
<span class="sd">    matching the input list. Returns a dictionary of {clientpk: serverpk}</span>
<span class="sd">    values for those that do.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">clientpk_name</span><span class="p">],</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span><span class="p">])</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">clientpk_name</span><span class="p">]</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">clientpk_values</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">clientpkdict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[int, int]</span>
    <span class="k">for</span> <span class="n">client_pk</span><span class="p">,</span> <span class="n">server_pk</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">clientpkdict</span><span class="p">[</span><span class="n">client_pk</span><span class="p">]</span> <span class="o">=</span> <span class="n">server_pk</span>
    <span class="k">return</span> <span class="n">clientpkdict</span></div>


<div class="viewcode-block" id="get_server_pks_of_specified_records"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_server_pks_of_specified_records">[docs]</a><span class="k">def</span> <span class="nf">get_server_pks_of_specified_records</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                        <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                                        <span class="n">wheredict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves server PKs for a table, for a given device, given a set of</span>
<span class="sd">    &#39;where&#39; conditions specified in wheredict (as field/value combinations,</span>
<span class="sd">    joined with AND).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span><span class="p">])</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">wheredict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fetch_all_first_values</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span></div>


<div class="viewcode-block" id="record_identical_full"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.record_identical_full">[docs]</a><span class="k">def</span> <span class="nf">record_identical_full</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                          <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                          <span class="n">serverpk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">wheredict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If a record with the specified server PK exists in the specified table</span>
<span class="sd">    having all its values matching the field/value combinations in wheredict</span>
<span class="sd">    (joined with AND), returns True. Otherwise, returns False.</span>
<span class="sd">    Used to detect if an incoming record matches the database record.</span>

<span class="sd">    CURRENTLY UNUSED.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">serverpk</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">wheredict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">criteria</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exists_in_table</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">)</span></div>


<div class="viewcode-block" id="record_identical_by_date"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.record_identical_by_date">[docs]</a><span class="k">def</span> <span class="nf">record_identical_by_date</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                             <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                             <span class="n">serverpk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                             <span class="n">client_date_value</span><span class="p">:</span> <span class="n">Pendulum</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shortcut to detecting a record being identical. Returns true if the</span>
<span class="sd">    record (defined by its table/server PK) has a CLIENT_DATE_FIELD field</span>
<span class="sd">    that matches that of the incoming record. As long as the tablet always</span>
<span class="sd">    updates the CLIENT_DATE_FIELD when it saves a record, and the clock on the</span>
<span class="sd">    device doesn&#39;t go backwards by a certain exact millisecond-precision value,</span>
<span class="sd">    this is a valid method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">serverpk</span><span class="p">,</span>
        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">CLIENT_DATE_FIELD</span><span class="p">]</span> <span class="o">==</span> <span class="n">client_date_value</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">exists_in_table</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">criteria</span><span class="p">)</span></div>


<div class="viewcode-block" id="upload_record_core"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.upload_record_core">[docs]</a><span class="k">def</span> <span class="nf">upload_record_core</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                       <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                       <span class="n">clientpk_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">valuedict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                       <span class="n">recordnum</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uploads a record. Deals with IDENTICAL, NEW, and MODIFIED records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="n">require_keys</span><span class="p">(</span><span class="n">valuedict</span><span class="p">,</span> <span class="p">[</span><span class="n">clientpk_name</span><span class="p">,</span> <span class="n">CLIENT_DATE_FIELD</span><span class="p">,</span>
                             <span class="n">MOVE_OFF_TABLET_FIELD</span><span class="p">])</span>
    <span class="n">clientpk_value</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="n">clientpk_name</span><span class="p">]</span>
    <span class="n">found</span><span class="p">,</span> <span class="n">oldserverpk</span> <span class="o">=</span> <span class="n">record_exists</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">clientpk_name</span><span class="p">,</span>
                                       <span class="n">clientpk_value</span><span class="p">)</span>
    <span class="n">newserverpk</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
        <span class="n">client_date_value</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="n">CLIENT_DATE_FIELD</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">record_identical_by_date</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">,</span>
                                    <span class="n">client_date_value</span><span class="p">):</span>
            <span class="c1"># log.critical(&quot;... record is identical&quot;)</span>
            <span class="c1"># IDENTICAL. No action needed...</span>
            <span class="c1"># UNLESS MOVE_OFF_TABLET_FIELDNAME is set</span>
            <span class="k">if</span> <span class="n">valuedict</span><span class="p">[</span><span class="n">MOVE_OFF_TABLET_FIELD</span><span class="p">]:</span>
                <span class="n">flag_record_for_preservation</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">)</span>
                <span class="c1"># log.debug(&quot;Table {table}, uploaded record {recordnum}: &quot;</span>
                <span class="c1">#           &quot;identical but moving off tablet&quot;,</span>
                <span class="c1">#           table=table, recordnum=recordnum)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># log.debug(&quot;Table {table}, uploaded record {recordnum}: &quot;</span>
                <span class="c1">#           &quot;identical&quot;, table=table, recordnum=recordnum)</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># MODIFIED</span>
            <span class="c1"># log.critical(&quot;... record is modified&quot;)</span>
            <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="n">Patient</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">cope_with_deleted_patient_descriptors</span><span class="p">:</span>
                    <span class="c1"># Old tablets (pre-2.0.0) will upload copies of the ID</span>
                    <span class="c1"># descriptions with the patient. To cope with that, we</span>
                    <span class="c1"># remove those here:</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUMBER_OF_IDNUMS_DEFUNCT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">nstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                        <span class="n">fn_desc</span> <span class="o">=</span> <span class="n">FP_ID_DESC</span> <span class="o">+</span> <span class="n">nstr</span>
                        <span class="n">fn_shortdesc</span> <span class="o">=</span> <span class="n">FP_ID_SHORT_DESC</span> <span class="o">+</span> <span class="n">nstr</span>
                        <span class="n">valuedict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fn_desc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># remove item, if exists</span>
                        <span class="n">valuedict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fn_shortdesc</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">cope_with_old_idnums</span><span class="p">:</span>
                    <span class="c1"># Insert records into the new ID number table from the old</span>
                    <span class="c1"># patient table:</span>
                    <span class="k">for</span> <span class="n">which_idnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUMBER_OF_IDNUMS_DEFUNCT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="n">nstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">which_idnum</span><span class="p">)</span>
                        <span class="n">fn_idnum</span> <span class="o">=</span> <span class="n">FP_ID_NUM</span> <span class="o">+</span> <span class="n">nstr</span>
                        <span class="n">idnum_value</span> <span class="o">=</span> <span class="n">valuedict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fn_idnum</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="c1"># ... and remove it from our new Patient record</span>
                        <span class="n">patient_id</span> <span class="o">=</span> <span class="n">valuedict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">idnum_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">patient_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PatientIdNum</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">upload_record_core</span><span class="p">(</span>
                            <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
                            <span class="n">table</span><span class="o">=</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span>
                            <span class="n">clientpk_name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                            <span class="n">valuedict</span><span class="o">=</span><span class="p">{</span>
                                <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">fake_tablet_id_for_patientidnum</span><span class="p">(</span>
                                    <span class="n">patient_id</span><span class="o">=</span><span class="n">patient_id</span><span class="p">,</span>
                                    <span class="n">which_idnum</span><span class="o">=</span><span class="n">which_idnum</span>
                                <span class="p">),</span>  <span class="c1"># ... guarantees a pseudo client PK</span>
                                <span class="s1">&#39;patient_id&#39;</span><span class="p">:</span> <span class="n">patient_id</span><span class="p">,</span>
                                <span class="s1">&#39;which_idnum&#39;</span><span class="p">:</span> <span class="n">which_idnum</span><span class="p">,</span>
                                <span class="s1">&#39;idnum_value&#39;</span><span class="p">:</span> <span class="n">idnum_value</span><span class="p">,</span>
                                <span class="n">CLIENT_DATE_FIELD</span><span class="p">:</span> <span class="n">client_date_value</span><span class="p">,</span>
                                <span class="n">MOVE_OFF_TABLET_FIELD</span><span class="p">:</span> <span class="n">valuedict</span><span class="p">[</span><span class="n">MOVE_OFF_TABLET_FIELD</span><span class="p">],</span>  <span class="c1"># noqa</span>
                            <span class="p">},</span>
                            <span class="n">recordnum</span><span class="o">=</span><span class="n">recordnum</span>
                        <span class="p">)</span>
                    <span class="c1"># Now, how to deal with deletion, i.e. records missing</span>
                    <span class="c1"># from the tablet?</span>
                    <span class="c1"># See our caller, upload_table().</span>

            <span class="n">newserverpk</span> <span class="o">=</span> <span class="n">insert_record</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">valuedict</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">)</span>
            <span class="n">flag_modified</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">,</span> <span class="n">newserverpk</span><span class="p">)</span>
            <span class="c1"># log.debug(&quot;Table {table}, record {recordnum}: modified&quot;,</span>
            <span class="c1">#           table=table.name, recordnum=recordnum)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># log.critical(&quot;... record is new&quot;)</span>
        <span class="c1"># NEW</span>
        <span class="n">newserverpk</span> <span class="o">=</span> <span class="n">insert_record</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">valuedict</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># log.debug(&quot;Table {table}, record {recordnum}: new&quot;,</span>
        <span class="c1">#           table=table.name, recordnum=recordnum)</span>
    <span class="k">return</span> <span class="n">oldserverpk</span><span class="p">,</span> <span class="n">newserverpk</span></div>


<div class="viewcode-block" id="insert_record"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.insert_record">[docs]</a><span class="k">def</span> <span class="nf">insert_record</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                  <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                  <span class="n">valuedict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                  <span class="n">predecessor_pk</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inserts a record, or raises an exception if that fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="n">valuedict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s2">&quot;_device_id&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
        <span class="s2">&quot;_era&quot;</span><span class="p">:</span> <span class="n">ERA_NOW</span><span class="p">,</span>
        <span class="s2">&quot;_current&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;_addition_pending&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;_removal_pending&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;_predecessor_pk&quot;</span><span class="p">:</span> <span class="n">predecessor_pk</span><span class="p">,</span>
        <span class="s2">&quot;_camcops_version&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">tablet_version_str</span><span class="p">,</span>
        <span class="s2">&quot;_group_id&quot;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">upload_group_id</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">valuedict</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
    <span class="k">return</span> <span class="n">rp</span><span class="o">.</span><span class="n">inserted_primary_key</span></div>


<div class="viewcode-block" id="duplicate_record"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.duplicate_record">[docs]</a><span class="k">def</span> <span class="nf">duplicate_record</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">serverpk</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Duplicates the record defined by the table/serverpk combination.</span>
<span class="sd">    Will raise an exception if the insert fails. Otherwise...</span>
<span class="sd">    The old record then NEEDS MODIFICATION by flag_modified().</span>
<span class="sd">    The new record NEEDS MODIFICATION by update_new_copy_of_record().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="c1"># Fetch the existing record.</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)])</span>
        <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">serverpk</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">rp</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ServerErrorException</span><span class="p">(</span>
            <span class="s2">&quot;Tried to fetch nonexistent record: table </span><span class="si">{t}</span><span class="s2">, PK </span><span class="si">{pk}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">t</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">serverpk</span><span class="p">))</span>
    <span class="n">valuedict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="c1"># Remove the PK from what we insert back (that will be autogenerated)</span>
    <span class="n">valuedict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_pk&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># ... or del d[&quot;_pk&quot;]; http://stackoverflow.com/questions/5447494</span>
    <span class="c1"># Perform the insert</span>
    <span class="n">insert_rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">valuedict</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
    <span class="k">return</span> <span class="n">insert_rp</span><span class="o">.</span><span class="n">inserted_primary_key</span></div>


<div class="viewcode-block" id="update_new_copy_of_record"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.update_new_copy_of_record">[docs]</a><span class="k">def</span> <span class="nf">update_new_copy_of_record</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                              <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                              <span class="n">serverpk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">valuedict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
                              <span class="n">predecessor_pk</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Following duplicate_record(), use this to modify the new copy (defined</span>
<span class="sd">    by the table/serverpk combination).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valuedict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">_current</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">_addition_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">_predecessor_pk</span><span class="o">=</span><span class="n">predecessor_pk</span><span class="p">,</span>
        <span class="n">_camcops_version</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">tablet_version_str</span>
    <span class="p">))</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">serverpk</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">valuedict</span><span class="p">)</span>
    <span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Batch (atomic) upload and preserving</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="get_batch_details_start_if_needed"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_batch_details_start_if_needed">[docs]</a><span class="k">def</span> <span class="nf">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Pendulum</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets a (upload_batch_utc, currently_preserving) tuple.</span>

<span class="sd">    upload_batch_utc: the batchtime; UTC date/time of the current upload batch.</span>
<span class="sd">    currently_preserving: Boolean; whether preservation (shifting to an older</span>
<span class="sd">    era) is currently taking place.</span>

<span class="sd">    SIDE EFFECT: if the username is different from the username that started</span>
<span class="sd">    a previous upload batch for this device, we restart the upload batch (thus</span>
<span class="sd">    rolling back previous pending changes).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">Device</span><span class="o">.</span><span class="n">ongoing_upload_batch_utc</span><span class="p">,</span>
                <span class="n">Device</span><span class="o">.</span><span class="n">uploading_user_id</span><span class="p">,</span>
                <span class="n">Device</span><span class="o">.</span><span class="n">currently_preserving</span><span class="p">])</span>
        <span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">upload_batch_utc</span><span class="p">,</span> <span class="n">uploading_user_id</span><span class="p">,</span> <span class="n">currently_preserving</span> <span class="o">=</span> <span class="n">row</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_batch_utc</span> <span class="ow">or</span> <span class="n">uploading_user_id</span> <span class="o">!=</span> <span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">:</span>
        <span class="c1"># SIDE EFFECT: if the username changes, we restart (and thus roll back</span>
        <span class="c1"># previous pending changes)</span>
        <span class="n">start_device_upload_batch</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">req</span><span class="o">.</span><span class="n">now_utc</span><span class="p">,</span> <span class="kc">False</span>
    <span class="c1"># log.debug(&quot;get_batch_details_start_if_needed: upload_batch_utc = {!r}&quot;,</span>
    <span class="c1">#           upload_batch_utc)</span>
    <span class="k">return</span> <span class="n">upload_batch_utc</span><span class="p">,</span> <span class="n">currently_preserving</span></div>


<div class="viewcode-block" id="start_device_upload_batch"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.start_device_upload_batch">[docs]</a><span class="k">def</span> <span class="nf">start_device_upload_batch</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts an upload batch for a device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rollback_all</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">last_upload_batch_utc</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">now_utc</span><span class="p">,</span>
                <span class="n">ongoing_upload_batch_utc</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">now_utc</span><span class="p">,</span>
                <span class="n">uploading_user_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="end_device_upload_batch"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.end_device_upload_batch">[docs]</a><span class="k">def</span> <span class="nf">end_device_upload_batch</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                            <span class="n">batchtime</span><span class="p">:</span> <span class="n">Pendulum</span><span class="p">,</span>
                            <span class="n">preserving</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ends an upload batch, committing all changes made thus far.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">commit_all</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">batchtime</span><span class="p">,</span> <span class="n">preserving</span><span class="p">)</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">ongoing_upload_batch_utc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">uploading_user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">currently_preserving</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="start_preserving"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.start_preserving">[docs]</a><span class="k">def</span> <span class="nf">start_preserving</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Starts preservation (the process of moving records from the NOW era to</span>
<span class="sd">    an older era, so they can be removed safely from the tablet).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">currently_preserving</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="mark_table_dirty"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.mark_table_dirty">[docs]</a><span class="k">def</span> <span class="nf">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks a table as having been modified during the current upload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="n">table_already_dirty</span> <span class="o">=</span> <span class="n">exists_in_table</span><span class="p">(</span>
        <span class="n">dbsession</span><span class="p">,</span>
        <span class="n">DirtyTable</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span>
        <span class="n">DirtyTable</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
        <span class="n">DirtyTable</span><span class="o">.</span><span class="n">tablename</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_already_dirty</span><span class="p">:</span>
        <span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">DirtyTable</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">device_id</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
                    <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="get_dirty_tables"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_dirty_tables">[docs]</a><span class="k">def</span> <span class="nf">get_dirty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Table</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns tables marked as dirty for this device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">([</span><span class="n">DirtyTable</span><span class="o">.</span><span class="n">tablename</span><span class="p">])</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DirtyTable</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">tablenames</span> <span class="o">=</span> <span class="n">fetch_all_first_values</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">CLIENT_TABLE_MAP</span><span class="p">[</span><span class="n">tn</span><span class="p">]</span> <span class="k">for</span> <span class="n">tn</span> <span class="ow">in</span> <span class="n">tablenames</span><span class="p">]</span></div>


<div class="viewcode-block" id="flag_deleted"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.flag_deleted">[docs]</a><span class="k">def</span> <span class="nf">flag_deleted</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                 <span class="n">pklist</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks record(s) as deleted, specified by a list of server PKs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">pklist</span><span class="p">))</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_removal_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">_successor_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="flag_all_records_deleted"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.flag_all_records_deleted">[docs]</a><span class="k">def</span> <span class="nf">flag_all_records_deleted</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks all records in a table as deleted (that are current and in the</span>
<span class="sd">    current era).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_removal_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">_successor_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="flag_deleted_where_clientpk_not"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.flag_deleted_where_clientpk_not">[docs]</a><span class="k">def</span> <span class="nf">flag_deleted_where_clientpk_not</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                    <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                                    <span class="n">clientpk_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                    <span class="n">clientpk_values</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks for deletion all current/current-era records for a device, defined</span>
<span class="sd">    by a list of client-side PK values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_current</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">clientpk_name</span><span class="p">]</span><span class="o">.</span><span class="n">notin_</span><span class="p">(</span><span class="n">clientpk_values</span><span class="p">))</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_removal_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">_successor_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="flag_modified"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.flag_modified">[docs]</a><span class="k">def</span> <span class="nf">flag_modified</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                  <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                  <span class="n">pk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                  <span class="n">successor_pk</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks a record as old, storing its successor&#39;s details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">pk</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_removal_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">_successor_pk</span><span class="o">=</span><span class="n">successor_pk</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="flag_record_for_preservation"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.flag_record_for_preservation">[docs]</a><span class="k">def</span> <span class="nf">flag_record_for_preservation</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                                 <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                                 <span class="n">pk</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks a record for preservation (moving off the tablet, changing its</span>
<span class="sd">    era details).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_pk</span> <span class="o">==</span> <span class="n">pk</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_move_off_tablet</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="commit_all"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.commit_all">[docs]</a><span class="k">def</span> <span class="nf">commit_all</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
               <span class="n">batchtime</span><span class="p">:</span> <span class="n">Pendulum</span><span class="p">,</span>
               <span class="n">preserving</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Commits additions, removals, and preservations for all tables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">get_dirty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">auditsegments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">n_added</span><span class="p">,</span> <span class="n">n_removed</span><span class="p">,</span> <span class="n">n_preserved</span> <span class="o">=</span> <span class="n">commit_table</span><span class="p">(</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">batchtime</span><span class="p">,</span> <span class="n">preserving</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">clear_dirty</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">auditsegments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{tablename}</span><span class="s2"> (</span><span class="si">{n_added}</span><span class="s2">,</span><span class="si">{n_removed}</span><span class="s2">,</span><span class="si">{n_preserved}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">n_added</span><span class="o">=</span><span class="n">n_added</span><span class="p">,</span>
                <span class="n">n_removed</span><span class="o">=</span><span class="n">n_removed</span><span class="p">,</span>
                <span class="n">n_preserved</span><span class="o">=</span><span class="n">n_preserved</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">clear_dirty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">details</span> <span class="o">=</span> <span class="s2">&quot;Upload [table (n_added,n_removed,n_preserved)]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">auditsegments</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span></div>


<div class="viewcode-block" id="commit_table"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.commit_table">[docs]</a><span class="k">def</span> <span class="nf">commit_table</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
                 <span class="n">batchtime</span><span class="p">:</span> <span class="n">Pendulum</span><span class="p">,</span>
                 <span class="n">preserving</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                 <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                 <span class="n">clear_dirty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Commits additions, removals, and preservations for one table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log.debug(&quot;commit_table: {}&quot;, table.name)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">user_id</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span>
    <span class="n">exacttime</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">now</span>

    <span class="c1"># Additions</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">addition_rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_addition_pending</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_current</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">_addition_pending</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">_adding_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">_when_added_exact</span><span class="o">=</span><span class="n">exacttime</span><span class="p">,</span>
                <span class="n">_when_added_batch_utc</span><span class="o">=</span><span class="n">batchtime</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
    <span class="n">n_added</span> <span class="o">=</span> <span class="n">addition_rp</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="c1"># Removals</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">removal_rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_removal_pending</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_current</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">_removal_pending</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">_removing_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">_when_removed_exact</span><span class="o">=</span><span class="n">exacttime</span><span class="p">,</span>
                <span class="n">_when_removed_batch_utc</span><span class="o">=</span><span class="n">batchtime</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
    <span class="n">n_removed</span> <span class="o">=</span> <span class="n">removal_rp</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="c1"># Preservation</span>
    <span class="n">new_era</span> <span class="o">=</span> <span class="n">format_datetime</span><span class="p">(</span><span class="n">batchtime</span><span class="p">,</span> <span class="n">DateFormat</span><span class="o">.</span><span class="n">ERA</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">preserving</span><span class="p">:</span>
        <span class="c1"># Preserve all relevant records</span>
        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">preserve_rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_era</span><span class="o">=</span><span class="n">new_era</span><span class="p">,</span>
                    <span class="n">_preserving_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">_move_off_tablet</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
        <span class="n">n_preserved</span> <span class="o">=</span> <span class="n">preserve_rp</span><span class="o">.</span><span class="n">rowcount</span>

        <span class="c1"># Also preserve/finalize any corresponding special notes (2015-02-01)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">basetable</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">era</span><span class="o">=</span><span class="n">new_era</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Preserve any individual records</span>
        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">preserve_rp</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_move_off_tablet</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_era</span><span class="o">=</span><span class="n">new_era</span><span class="p">,</span>
                    <span class="n">_preserving_user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">_move_off_tablet</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># type: ResultProxy</span>
        <span class="n">n_preserved</span> <span class="o">=</span> <span class="n">preserve_rp</span><span class="o">.</span><span class="n">rowcount</span>

        <span class="c1"># Also preserve/finalize any corresponding special notes (2015-02-01)</span>
        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">basetable</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">SpecialNote</span><span class="o">.</span><span class="n">era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">SpecialNote</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">SpecialNote</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">new_era</span><span class="p">))</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">era</span><span class="o">=</span><span class="n">new_era</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Remove individually from list of dirty tables?</span>
    <span class="k">if</span> <span class="n">clear_dirty</span><span class="p">:</span>
        <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">DirtyTable</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DirtyTable</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DirtyTable</span><span class="o">.</span><span class="n">tablename</span> <span class="o">==</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># ... otherwise a call to clear_dirty_tables() must be made.</span>

    <span class="k">return</span> <span class="n">n_added</span><span class="p">,</span> <span class="n">n_removed</span><span class="p">,</span> <span class="n">n_preserved</span></div>


<div class="viewcode-block" id="rollback_all"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.rollback_all">[docs]</a><span class="k">def</span> <span class="nf">rollback_all</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rolls back all pending changes for a device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">get_dirty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">rollback_table</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">clear_dirty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>


<div class="viewcode-block" id="rollback_table"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.rollback_table">[docs]</a><span class="k">def</span> <span class="nf">rollback_table</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rolls back changes for an individual table for a device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device_id</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span>
    <span class="c1"># Pending additions</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_addition_pending</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Pending deletions</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_removal_pending</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_removal_pending</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">_when_removed_exact</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">_when_removed_batch_utc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">_removing_user_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">_successor_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># Record-specific preservation (set by flag_record_for_preservation())</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">device_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_move_off_tablet</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="clear_dirty_tables"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.clear_dirty_tables">[docs]</a><span class="k">def</span> <span class="nf">clear_dirty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clears the dirty-table list for a device.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">DirtyTable</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DirtyTable</span><span class="o">.</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
    <span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Audit functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="audit"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.audit">[docs]</a><span class="k">def</span> <span class="nf">audit</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">,</span>
          <span class="n">details</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
          <span class="n">patient_server_pk</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">server_pk</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Audit something.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Add parameters and pass on:</span>
    <span class="n">cc_audit</span><span class="o">.</span><span class="n">audit</span><span class="p">(</span>
        <span class="n">req</span><span class="o">=</span><span class="n">req</span><span class="p">,</span>
        <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
        <span class="n">patient_server_pk</span><span class="o">=</span><span class="n">patient_server_pk</span><span class="p">,</span>
        <span class="n">table</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span>
        <span class="n">server_pk</span><span class="o">=</span><span class="n">server_pk</span><span class="p">,</span>
        <span class="n">device_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>  <span class="c1"># added</span>
        <span class="n">remote_addr</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">,</span>  <span class="c1"># added</span>
        <span class="n">user_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>  <span class="c1"># added</span>
        <span class="n">from_console</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># added</span>
        <span class="n">from_dbclient</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># added</span>
    <span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Action processors: allowed to any user</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># If they return None, the framework uses the operation name as the reply in</span>
<span class="c1"># the success message. Not returning anything is the same as returning None.</span>
<span class="c1"># Authentication is performed in advance of these.</span>

<div class="viewcode-block" id="check_device_registered"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.check_device_registered">[docs]</a><span class="k">def</span> <span class="nf">check_device_registered</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that a device is registered, or raise UserErrorException.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">ensure_device_registered</span><span class="p">()</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Action processors that require REGISTRATION privilege</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="register"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.register">[docs]</a><span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register a device with the server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="n">device_friendly_name</span> <span class="o">=</span> <span class="n">get_str_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">DEVICE_FRIENDLY_NAME</span><span class="p">,</span>
                                       <span class="n">mandatory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">device_exists</span> <span class="o">=</span> <span class="n">exists_in_table</span><span class="p">(</span>
        <span class="n">dbsession</span><span class="p">,</span>
        <span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span>
        <span class="n">Device</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">device_name</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">device_exists</span><span class="p">:</span>
        <span class="c1"># device already registered, but accept re-registration</span>
        <span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Device</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ts</span><span class="o">.</span><span class="n">device_name</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">friendly_name</span><span class="o">=</span><span class="n">device_friendly_name</span><span class="p">,</span>
                    <span class="n">camcops_version</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">tablet_version_str</span><span class="p">,</span>
                    <span class="n">registered_by_user_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                    <span class="n">when_registered_utc</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">now_utc</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># new registration</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">Device</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span>
                <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">device_name</span><span class="p">,</span>
                        <span class="n">friendly_name</span><span class="o">=</span><span class="n">device_friendly_name</span><span class="p">,</span>
                        <span class="n">camcops_version</span><span class="o">=</span><span class="n">ts</span><span class="o">.</span><span class="n">tablet_version_str</span><span class="p">,</span>
                        <span class="n">registered_by_user_id</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                        <span class="n">when_registered_utc</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">now_utc</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">IntegrityError</span><span class="p">:</span>
            <span class="n">fail_user_error</span><span class="p">(</span><span class="n">INSERT_FAILED</span><span class="p">)</span>

    <span class="n">ts</span><span class="o">.</span><span class="n">reload_device</span><span class="p">()</span>
    <span class="n">audit</span><span class="p">(</span>
        <span class="n">req</span><span class="p">,</span>
        <span class="s2">&quot;register, device_id=</span><span class="si">{}</span><span class="s2">, friendly_name=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span> <span class="n">device_friendly_name</span><span class="p">),</span>
        <span class="n">tablename</span><span class="o">=</span><span class="n">Device</span><span class="o">.</span><span class="n">__tablename__</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">get_server_id_info</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_extra_strings"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_extra_strings">[docs]</a><span class="k">def</span> <span class="nf">get_extra_strings</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch all local extra strings from the server.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">ExtraStringFieldNames</span><span class="o">.</span><span class="n">TASK</span><span class="p">,</span>
              <span class="n">ExtraStringFieldNames</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span>
              <span class="n">ExtraStringFieldNames</span><span class="o">.</span><span class="n">VALUE</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">get_all_extra_strings</span><span class="p">()</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="n">get_select_reply</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;get_extra_strings&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reply</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="get_allowed_tables"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_allowed_tables">[docs]</a><span class="k">def</span> <span class="nf">get_allowed_tables</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the names of all possible tables on the server, each paired with</span>
<span class="sd">    the minimum client (tablet) version that will be accepted for each table.</span>
<span class="sd">    (Typically these are all the same as the minimum global tablet version.)</span>

<span class="sd">    Uses the SELECT-like syntax.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tables_versions</span> <span class="o">=</span> <span class="n">all_tables_with_min_client_version</span><span class="p">()</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">AllowedTablesFieldNames</span><span class="o">.</span><span class="n">TABLENAME</span><span class="p">,</span>
              <span class="n">AllowedTablesFieldNames</span><span class="o">.</span><span class="n">MIN_CLIENT_VERSION</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">tables_versions</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="n">reply</span> <span class="o">=</span> <span class="n">get_select_reply</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">rows</span><span class="p">)</span>
    <span class="n">audit</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;get_allowed_tables&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">reply</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Action processors that require UPLOAD privilege</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="check_upload_user_and_device"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.check_upload_user_and_device">[docs]</a><span class="k">def</span> <span class="nf">check_upload_user_and_device</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stub function for the operation to check that a user is valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>  <span class="c1"># don&#39;t need to do anything!</span></div>


<span class="c1"># noinspection PyUnusedLocal</span>
<div class="viewcode-block" id="get_id_info"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.get_id_info">[docs]</a><span class="k">def</span> <span class="nf">get_id_info</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch server ID information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_server_id_info</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>


<div class="viewcode-block" id="start_upload"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.start_upload">[docs]</a><span class="k">def</span> <span class="nf">start_upload</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Begin an upload.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_device_upload_batch</span><span class="p">(</span><span class="n">req</span><span class="p">)</span></div>


<div class="viewcode-block" id="end_upload"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.end_upload">[docs]</a><span class="k">def</span> <span class="nf">end_upload</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ends an upload and commits changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batchtime</span><span class="p">,</span> <span class="n">preserving</span> <span class="o">=</span> <span class="n">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="c1"># ensure it&#39;s the same user finishing as starting!</span>
    <span class="n">end_device_upload_batch</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">batchtime</span><span class="p">,</span> <span class="n">preserving</span><span class="p">)</span></div>


<div class="viewcode-block" id="upload_table"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.upload_table">[docs]</a><span class="k">def</span> <span class="nf">upload_table</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a table.</span>

<span class="sd">    Incoming information in the POST request includes a CSV list of fields, a</span>
<span class="sd">    count of the number of records being provided, and a set of variables named</span>
<span class="sd">    record0 ... record{nrecords}, each containing a CSV list of SQL-encoded</span>
<span class="sd">    values.</span>

<span class="sd">    Typically used for smaller tables, i.e. most except for BLOBs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">get_table_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">)</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">get_fields_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">)</span>
    <span class="n">nrecords</span> <span class="o">=</span> <span class="n">get_int_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">NRECORDS</span><span class="p">)</span>

    <span class="n">nfields</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nfields</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">: can&#39;t be less than 1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">,</span> <span class="n">nfields</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">nrecords</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">: can&#39;t be less than 0&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">NRECORDS</span><span class="p">,</span> <span class="n">nrecords</span><span class="p">))</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">explicit_pkname_for_upload_table</span><span class="p">:</span>  <span class="c1"># q.v.</span>
        <span class="c1"># New client: tells us the PK name explicitly.</span>
        <span class="n">clientpk_name</span> <span class="o">=</span> <span class="n">get_single_field_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
                                                       <span class="n">TabletParam</span><span class="o">.</span><span class="n">PKNAME</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Old client. Either (a) old Titanium client, in which the client PK</span>
        <span class="c1"># is in fields[0], or (b) an early C++ client, in which there was no</span>
        <span class="c1"># guaranteed order (and no explicit PK name was sent). However, in</span>
        <span class="c1"># either case, the client PK name was (is) always &quot;id&quot;.</span>
        <span class="n">clientpk_name</span> <span class="o">=</span> <span class="n">TABLET_ID_FIELD</span>
        <span class="n">ensure_valid_field_name</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">clientpk_name</span><span class="p">)</span>
    <span class="n">server_pks_uploaded</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n_new</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_modified</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n_identical</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">server_active_record_pks</span> <span class="o">=</span> <span class="n">get_server_pks_of_active_records</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrecords</span><span class="p">):</span>
        <span class="n">recname</span> <span class="o">=</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">RECORD_PREFIX</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">get_values_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">recname</span><span class="p">)</span>
        <span class="n">nvalues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nvalues</span> <span class="o">!=</span> <span class="n">nfields</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Number of fields in field list (</span><span class="si">{nfields}</span><span class="s2">) doesn&#39;t match &quot;</span>
                <span class="s2">&quot;number of values in record </span><span class="si">{r}</span><span class="s2"> (</span><span class="si">{nvalues}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nfields</span><span class="o">=</span><span class="n">nfields</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">nvalues</span><span class="o">=</span><span class="n">nvalues</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">errmsg</span> <span class="o">+</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">fields: </span><span class="si">{!r}</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;values: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="n">fail_user_error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
        <span class="n">valuedict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>
        <span class="c1"># log.critical(&quot;table {!r}, record {}: {!r}&quot;, table.name, r, valuedict)</span>
        <span class="c1"># CORE: CALLS upload_record_core</span>
        <span class="n">oldserverpk</span><span class="p">,</span> <span class="n">newserverpk</span> <span class="o">=</span> <span class="n">upload_record_core</span><span class="p">(</span>
            <span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">clientpk_name</span><span class="p">,</span> <span class="n">valuedict</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oldserverpk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">server_pks_uploaded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oldserverpk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newserverpk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">n_identical</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_modified</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_new</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Now deal with any ABSENT (not in uploaded data set) conditions.</span>
    <span class="n">server_pks_for_deletion</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">server_active_record_pks</span>
                               <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">server_pks_uploaded</span><span class="p">]</span>
    <span class="n">n_deleted</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">server_pks_for_deletion</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_deleted</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">flag_deleted</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">server_pks_for_deletion</span><span class="p">)</span>

    <span class="c1"># Special for old tablets:</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span><span class="o">.</span><span class="n">cope_with_old_idnums</span> <span class="ow">and</span> <span class="n">table</span> <span class="o">==</span> <span class="n">Patient</span><span class="o">.</span><span class="n">__table__</span><span class="p">:</span>
        <span class="n">mark_table_dirty</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">PatientIdNum</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
        <span class="c1"># Mark patient ID numbers for deletion if their parent Patient is</span>
        <span class="c1"># similarly being marked for deletion</span>
        <span class="c1"># noinspection PyProtectedMember</span>
        <span class="n">req</span><span class="o">.</span><span class="n">dbsession</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">_device_id</span> <span class="o">==</span> <span class="n">Patient</span><span class="o">.</span><span class="n">_device_id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">PatientIdNum</span><span class="o">.</span><span class="n">patient_id</span> <span class="o">==</span> <span class="n">Patient</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">_pk</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">server_pks_for_deletion</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Patient</span><span class="o">.</span><span class="n">_era</span> <span class="o">==</span> <span class="n">ERA_NOW</span><span class="p">)</span>  <span class="c1"># shouldn&#39;t be in doubt!</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">_removal_pending</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">_successor_pk</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Success</span>
    <span class="c1"># log.debug(</span>
    <span class="c1">#     &quot;Table {t}: server_active_record_pks: {a}; server_pks_uploaded: {u}; &quot;</span>
    <span class="c1">#     &quot;server_pks_for_deletion: {d}; &quot;</span>
    <span class="c1">#     &quot;number of missing records (deleted): {nd}&quot;.format(</span>
    <span class="c1">#         t=table.name,</span>
    <span class="c1">#         a=server_active_record_pks,</span>
    <span class="c1">#         u=server_pks_uploaded,</span>
    <span class="c1">#         d=server_pks_for_deletion,</span>
    <span class="c1">#         nd=n_deleted</span>
    <span class="c1">#     )</span>
    <span class="c1"># )</span>
    <span class="c1"># Auditing occurs at commit_all.</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Upload successful; </span><span class="si">{n}</span><span class="s2"> records uploaded to table </span><span class="si">{t}</span><span class="s2"> &quot;</span>
             <span class="s2">&quot;(</span><span class="si">{new}</span><span class="s2"> new, </span><span class="si">{mod}</span><span class="s2"> modified, </span><span class="si">{i}</span><span class="s2"> identical, </span><span class="si">{nd}</span><span class="s2"> deleted)&quot;</span><span class="p">,</span>
             <span class="n">n</span><span class="o">=</span><span class="n">nrecords</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">n_new</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="n">n_modified</span><span class="p">,</span>
             <span class="n">i</span><span class="o">=</span><span class="n">n_identical</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">n_deleted</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2"> upload successful&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="upload_record"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.upload_record">[docs]</a><span class="k">def</span> <span class="nf">upload_record</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload an individual record. (Typically used for BLOBs.)</span>
<span class="sd">    Incoming POST information includes a CSV list of fields and a CSV list of</span>
<span class="sd">    values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">get_table_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">)</span>
    <span class="n">clientpk_name</span> <span class="o">=</span> <span class="n">get_single_field_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
                                                   <span class="n">TabletParam</span><span class="o">.</span><span class="n">PKNAME</span><span class="p">)</span>
    <span class="n">valuedict</span> <span class="o">=</span> <span class="n">get_fields_and_values</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
                                      <span class="n">TabletParam</span><span class="o">.</span><span class="n">FIELDS</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">VALUES</span><span class="p">)</span>
    <span class="n">require_keys</span><span class="p">(</span><span class="n">valuedict</span><span class="p">,</span> <span class="p">[</span><span class="n">clientpk_name</span><span class="p">,</span> <span class="n">CLIENT_DATE_FIELD</span><span class="p">])</span>
    <span class="n">clientpk_value</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="n">clientpk_name</span><span class="p">]</span>
    <span class="n">wheredict</span> <span class="o">=</span> <span class="p">{</span><span class="n">clientpk_name</span><span class="p">:</span> <span class="n">clientpk_value</span><span class="p">}</span>

    <span class="n">serverpks</span> <span class="o">=</span> <span class="n">get_server_pks_of_specified_records</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">wheredict</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">serverpks</span><span class="p">:</span>
        <span class="c1"># Insert</span>
        <span class="n">insert_record</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">valuedict</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;upload-insert&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;UPLOAD-INSERT&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Update</span>
        <span class="n">oldserverpk</span> <span class="o">=</span> <span class="n">serverpks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">client_date_value</span> <span class="o">=</span> <span class="n">valuedict</span><span class="p">[</span><span class="n">CLIENT_DATE_FIELD</span><span class="p">]</span>
        <span class="n">rec_exists</span> <span class="o">=</span> <span class="n">record_identical_by_date</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">,</span>
                                              <span class="n">client_date_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rec_exists</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;upload-update: skipping existing record&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newserverpk</span> <span class="o">=</span> <span class="n">duplicate_record</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">)</span>
            <span class="n">flag_modified</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">oldserverpk</span><span class="p">,</span> <span class="n">newserverpk</span><span class="p">)</span>
            <span class="n">update_new_copy_of_record</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">newserverpk</span><span class="p">,</span> <span class="n">valuedict</span><span class="p">,</span>
                                      <span class="n">oldserverpk</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;upload-update&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;UPLOAD-UPDATE&quot;</span></div>
    <span class="c1"># Auditing occurs at commit_all.</span>


<div class="viewcode-block" id="upload_empty_tables"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.upload_empty_tables">[docs]</a><span class="k">def</span> <span class="nf">upload_empty_tables</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The tablet supplies a list of tables that are empty at its end, and we</span>
<span class="sd">    will &#39;wipe&#39; all appropriate tables; this reduces the number of HTTP</span>
<span class="sd">    requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">get_tables_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLES</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">flag_all_records_deleted</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;upload_empty_tables&quot;</span><span class="p">)</span>
    <span class="c1"># Auditing occurs at commit_all.</span>
    <span class="k">return</span> <span class="s2">&quot;UPLOAD-EMPTY-TABLES&quot;</span></div>


<div class="viewcode-block" id="start_preservation"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.start_preservation">[docs]</a><span class="k">def</span> <span class="nf">start_preservation</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks this upload batch as one in which all records will be preserved</span>
<span class="sd">    (i.e. moved from NOW-era to an older era, so they can be deleted safely</span>
<span class="sd">    from the tablet).</span>

<span class="sd">    Without this, individual records can still be marked for preservation if</span>
<span class="sd">    their MOVE_OFF_TABLET_FIELD field (_move_off_tablet) is set; see</span>
<span class="sd">    upload_record and its functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">start_preserving</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start_preservation successful&quot;</span><span class="p">)</span>
    <span class="c1"># Auditing occurs at commit_all.</span>
    <span class="k">return</span> <span class="s2">&quot;STARTPRESERVATION&quot;</span></div>


<div class="viewcode-block" id="delete_where_key_not"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.delete_where_key_not">[docs]</a><span class="k">def</span> <span class="nf">delete_where_key_not</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Marks records for deletion, for a device/table, where the client PK</span>
<span class="sd">    is not in a specified list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">get_table_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">)</span>
    <span class="n">clientpk_name</span> <span class="o">=</span> <span class="n">get_single_field_from_post_var</span><span class="p">(</span>
        <span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">PKNAME</span><span class="p">)</span>
    <span class="n">clientpk_values</span> <span class="o">=</span> <span class="n">get_values_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">PKVALUES</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="n">flag_deleted_where_clientpk_not</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">clientpk_name</span><span class="p">,</span> <span class="n">clientpk_values</span><span class="p">)</span>
    <span class="c1"># Auditing occurs at commit_all.</span>
    <span class="c1"># log.info(&quot;delete_where_key_not successful; table {} trimmed&quot;, table)</span>
    <span class="k">return</span> <span class="s2">&quot;Trimmed&quot;</span></div>


<div class="viewcode-block" id="which_keys_to_send"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.which_keys_to_send">[docs]</a><span class="k">def</span> <span class="nf">which_keys_to_send</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Intended use: &quot;For my device, and a specified table, here are my client-</span>
<span class="sd">    side PKs (as a CSV list), and the modification dates for each corresponding</span>
<span class="sd">    record (as a CSV list). Please tell me which records have mismatching dates</span>
<span class="sd">    on the server, i.e. those that I need to re-upload.&quot;</span>

<span class="sd">    Used particularly for BLOBs, to reduce traffic, i.e. so we don&#39;t have to</span>
<span class="sd">    send a lot of BLOBs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">get_table_from_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">IgnoringAntiqueTableException</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">IgnoringAntiqueTableException</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">clientpk_name</span> <span class="o">=</span> <span class="n">get_single_field_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
                                                   <span class="n">TabletParam</span><span class="o">.</span><span class="n">PKNAME</span><span class="p">)</span>
    <span class="n">clientpk_values</span> <span class="o">=</span> <span class="n">get_values_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">PKVALUES</span><span class="p">,</span>
                                               <span class="n">mandatory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># ... should be autoconverted to int, but we check below</span>
    <span class="n">client_dates</span> <span class="o">=</span> <span class="n">get_values_from_post_var</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">TabletParam</span><span class="o">.</span><span class="n">DATEVALUES</span><span class="p">,</span>
                                            <span class="n">mandatory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># ... will be in string format</span>

    <span class="n">npkvalues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">clientpk_values</span><span class="p">)</span>
    <span class="n">ndatevalues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">client_dates</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">npkvalues</span> <span class="o">!=</span> <span class="n">ndatevalues</span><span class="p">:</span>
        <span class="n">fail_user_error</span><span class="p">(</span>
            <span class="s2">&quot;Number of PK values (</span><span class="si">{npk}</span><span class="s2">) doesn&#39;t match number of dates &quot;</span>
            <span class="s2">&quot;(</span><span class="si">{nd}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npk</span><span class="o">=</span><span class="n">npkvalues</span><span class="p">,</span> <span class="n">nd</span><span class="o">=</span><span class="n">ndatevalues</span><span class="p">))</span>

    <span class="n">client_pk_to_datetime</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[int, Pendulum]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npkvalues</span><span class="p">):</span>
        <span class="n">cpkv</span> <span class="o">=</span> <span class="n">clientpk_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpkv</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Bad (non-integer) client PK: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpkv</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">coerce_to_pendulum</span><span class="p">(</span><span class="n">client_dates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Missing date/time for client &quot;</span>
                                <span class="s2">&quot;PK </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpkv</span><span class="p">))</span>
            <span class="n">client_pk_to_datetime</span><span class="p">[</span><span class="n">cpkv</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;Bad date/time: </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">client_dates</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_batch_details_start_if_needed</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>

    <span class="c1"># 1. The client sends us all its PKs. So &quot;delete&quot; anything not in that</span>
    <span class="c1">#    list.</span>
    <span class="n">flag_deleted_where_clientpk_not</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">clientpk_name</span><span class="p">,</span> <span class="n">clientpk_values</span><span class="p">)</span>

    <span class="c1"># 2. See which ones are new or updates.</span>
    <span class="n">pks_needed</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">client_pks_on_server_to_spk</span> <span class="o">=</span> <span class="n">client_pks_that_exist</span><span class="p">(</span>
        <span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">clientpk_name</span><span class="p">,</span> <span class="n">clientpk_values</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">clientpkval</span> <span class="ow">in</span> <span class="n">clientpk_values</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">clientpkval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">client_pks_on_server_to_spk</span><span class="p">:</span>
            <span class="n">pks_needed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clientpkval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">serverpk</span> <span class="o">=</span> <span class="n">client_pks_on_server_to_spk</span><span class="p">[</span><span class="n">clientpkval</span><span class="p">]</span>
            <span class="n">when</span> <span class="o">=</span> <span class="n">client_pk_to_datetime</span><span class="p">[</span><span class="n">clientpkval</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">record_identical_by_date</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">serverpk</span><span class="p">,</span> <span class="n">when</span><span class="p">):</span>
                <span class="n">pks_needed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clientpkval</span><span class="p">)</span>

    <span class="c1"># Success</span>
    <span class="n">pk_csv_list</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pks_needed</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
    <span class="c1"># log.info(&quot;which_keys_to_send successful: table {}&quot;, table.name)</span>
    <span class="k">return</span> <span class="n">pk_csv_list</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Action maps</span>
<span class="c1"># =============================================================================</span>

<span class="k">class</span> <span class="nc">Operations</span><span class="p">:</span>
    <span class="n">CHECK_DEVICE_REGISTERED</span> <span class="o">=</span> <span class="s2">&quot;check_device_registered&quot;</span>
    <span class="n">CHECK_UPLOAD_USER_DEVICE</span> <span class="o">=</span> <span class="s2">&quot;check_upload_user_and_device&quot;</span>
    <span class="n">DELETE_WHERE_KEY_NOT</span> <span class="o">=</span> <span class="s2">&quot;delete_where_key_not&quot;</span>
    <span class="n">END_UPLOAD</span> <span class="o">=</span> <span class="s2">&quot;end_upload&quot;</span>
    <span class="n">GET_EXTRA_STRINGS</span> <span class="o">=</span> <span class="s2">&quot;get_extra_strings&quot;</span>
    <span class="n">GET_ID_INFO</span> <span class="o">=</span> <span class="s2">&quot;get_id_info&quot;</span>
    <span class="n">GET_ALLOWED_TABLES</span> <span class="o">=</span> <span class="s2">&quot;get_allowed_tables&quot;</span>  <span class="c1"># v2.2.0</span>
    <span class="n">REGISTER</span> <span class="o">=</span> <span class="s2">&quot;register&quot;</span>
    <span class="n">START_PRESERVATION</span> <span class="o">=</span> <span class="s2">&quot;start_preservation&quot;</span>
    <span class="n">START_UPLOAD</span> <span class="o">=</span> <span class="s2">&quot;start_upload&quot;</span>
    <span class="n">UPLOAD_TABLE</span> <span class="o">=</span> <span class="s2">&quot;upload_table&quot;</span>
    <span class="n">UPLOAD_RECORD</span> <span class="o">=</span> <span class="s2">&quot;upload_record&quot;</span>
    <span class="n">UPLOAD_EMPTY_TABLES</span> <span class="o">=</span> <span class="s2">&quot;upload_empty_tables&quot;</span>
    <span class="n">WHICH_KEYS_TO_SEND</span> <span class="o">=</span> <span class="s2">&quot;which_keys_to_send&quot;</span>


<span class="n">OPERATIONS_ANYONE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">CHECK_DEVICE_REGISTERED</span><span class="p">:</span> <span class="n">check_device_registered</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">OPERATIONS_REGISTRATION</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">REGISTER</span><span class="p">:</span> <span class="n">register</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">GET_EXTRA_STRINGS</span><span class="p">:</span> <span class="n">get_extra_strings</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">GET_ALLOWED_TABLES</span><span class="p">:</span> <span class="n">get_allowed_tables</span><span class="p">,</span>  <span class="c1"># v2.2.0  # noqa</span>
<span class="p">}</span>
<span class="n">OPERATIONS_UPLOAD</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">CHECK_UPLOAD_USER_DEVICE</span><span class="p">:</span> <span class="n">check_upload_user_and_device</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">GET_ID_INFO</span><span class="p">:</span> <span class="n">get_id_info</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">START_UPLOAD</span><span class="p">:</span> <span class="n">start_upload</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">END_UPLOAD</span><span class="p">:</span> <span class="n">end_upload</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">UPLOAD_TABLE</span><span class="p">:</span> <span class="n">upload_table</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">UPLOAD_RECORD</span><span class="p">:</span> <span class="n">upload_record</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">UPLOAD_EMPTY_TABLES</span><span class="p">:</span> <span class="n">upload_empty_tables</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">START_PRESERVATION</span><span class="p">:</span> <span class="n">start_preservation</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">DELETE_WHERE_KEY_NOT</span><span class="p">:</span> <span class="n">delete_where_key_not</span><span class="p">,</span>
    <span class="n">Operations</span><span class="o">.</span><span class="n">WHICH_KEYS_TO_SEND</span><span class="p">:</span> <span class="n">which_keys_to_send</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Client API main functions</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="main_client_api"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.main_client_api">[docs]</a><span class="k">def</span> <span class="nf">main_client_api</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main HTTP processor.</span>

<span class="sd">    For success, returns a dictionary to send (will use status &#39;200 OK&#39;)</span>
<span class="sd">    For failure, raises an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log.info(&quot;CamCOPS database script starting at {}&quot;,</span>
    <span class="c1">#          format_datetime(req.now, DateFormat.ISO8601))</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">operation</span> <span class="ow">in</span> <span class="n">OPERATIONS_ANYONE</span><span class="p">:</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">OPERATIONS_ANYONE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">operation</span> <span class="ow">in</span> <span class="n">OPERATIONS_REGISTRATION</span><span class="p">:</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">ensure_valid_user_for_device_registration</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">OPERATIONS_REGISTRATION</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ts</span><span class="o">.</span><span class="n">operation</span> <span class="ow">in</span> <span class="n">OPERATIONS_UPLOAD</span><span class="p">:</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">ensure_valid_device_and_user_for_uploading</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">OPERATIONS_UPLOAD</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
        <span class="n">fail_unsupported_operation</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">RESULT</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">operation</span><span class="p">}</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">RESULT</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="client_api"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.client_api">[docs]</a><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="n">Routes</span><span class="o">.</span><span class="n">CLIENT_API</span><span class="p">,</span> <span class="n">permission</span><span class="o">=</span><span class="n">NO_PERMISSION_REQUIRED</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">client_api</span><span class="p">(</span><span class="n">req</span><span class="p">:</span> <span class="n">CamcopsRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View for client API. All tablet interaction comes through here.</span>
<span class="sd">    Wraps main_client_api().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log.critical(&quot;{!r}&quot;, req.environ)</span>
    <span class="c1"># log.critical(&quot;{!r}&quot;, req.params)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># in seconds</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">resultdict</span> <span class="o">=</span> <span class="n">main_client_api</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
        <span class="n">resultdict</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SUCCESS_CODE</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
    <span class="k">except</span> <span class="n">IgnoringAntiqueTableException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">IGNORING_ANTIQUE_TABLE_MESSAGE</span><span class="p">)</span>
        <span class="n">resultdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">RESULT</span><span class="p">:</span> <span class="n">escape_newlines</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span> <span class="n">SUCCESS_CODE</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
    <span class="k">except</span> <span class="n">UserErrorException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;CLIENT-SIDE SCRIPT ERROR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">resultdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span> <span class="n">FAILURE_CODE</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">escape_newlines</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>
    <span class="k">except</span> <span class="n">ServerErrorException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SERVER-SIDE SCRIPT ERROR: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="c1"># rollback? Not sure</span>
        <span class="n">resultdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span> <span class="n">FAILURE_CODE</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">escape_newlines</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;503 Database Unavailable: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># All other exceptions. May include database write failures.</span>
        <span class="c1"># Let&#39;s return with status &#39;200 OK&#39;; though this seems dumb, it means</span>
        <span class="c1"># the tablet user will at least see the message.</span>
        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Unhandled exception&quot;</span><span class="p">)</span>  <span class="c1"># + traceback.format_exc()</span>
        <span class="n">resultdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">:</span> <span class="n">FAILURE_CODE</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">ERROR</span><span class="p">:</span> <span class="n">escape_newlines</span><span class="p">(</span><span class="n">exception_description</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;200 OK&#39;</span>

    <span class="c1"># Add session token information</span>
    <span class="n">ts</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">tabletsession</span>
    <span class="n">resultdict</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">SESSION_ID</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">session_id</span>
    <span class="n">resultdict</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">SESSION_TOKEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">session_token</span>

    <span class="c1"># Convert dictionary to text in name-value pair format</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resultdict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Time in script (s): </span><span class="si">{t}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">TextResponse</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Unit tests</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">get_reply_dict_from_response</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">txt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, str]</span>
    <span class="c1"># Format is: &quot;200 OK\r\n&lt;other headers&gt;\r\n\r\n&lt;content&gt;&quot;</span>
    <span class="c1"># There&#39;s a blank line between the heads and the body.</span>
    <span class="n">http_gap</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span>
    <span class="n">camcops_linesplit</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">camcops_k_v_sep</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start_of_content</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">http_gap</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">http_gap</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">txt</span><span class="p">[</span><span class="n">start_of_content</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">camcops_linesplit</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">colon_pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">camcops_k_v_sep</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">colon_pos</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">colon_pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">camcops_k_v_sep</span><span class="p">):]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>


<div class="viewcode-block" id="ClientApiTests"><a class="viewcode-back" href="../../../autodoc/cc_modules/client_api.html#camcops_server.cc_modules.client_api.ClientApiTests">[docs]</a><span class="k">class</span> <span class="nc">ClientApiTests</span><span class="p">(</span><span class="n">DemoDatabaseTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_client_api_basics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span><span class="s2">&quot;test_client_api_basics&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserErrorException</span><span class="p">):</span>
            <span class="n">fail_user_error</span><span class="p">(</span><span class="s2">&quot;testmsg&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">ServerErrorException</span><span class="p">):</span>
            <span class="n">fail_server_error</span><span class="p">(</span><span class="s2">&quot;testmsg&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">UserErrorException</span><span class="p">):</span>
            <span class="n">fail_unsupported_operation</span><span class="p">(</span><span class="s2">&quot;duffop&quot;</span><span class="p">)</span>

        <span class="c1"># Encoding/decoding tests</span>
        <span class="c1"># data = bytearray(&quot;hello&quot;)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;hello&quot;</span>
        <span class="n">enc_b64data</span> <span class="o">=</span> <span class="n">base64_64format_encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">enc_hexdata</span> <span class="o">=</span> <span class="n">hex_xformat_encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">not_enc_1</span> <span class="o">=</span> <span class="s2">&quot;X&#39;012345&#39;&quot;</span>
        <span class="n">not_enc_2</span> <span class="o">=</span> <span class="s2">&quot;64&#39;aGVsbG8=&#39;&quot;</span>
        <span class="n">teststring</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;one, two, 3, 4.5, NULL, &#39;hello &quot;hi</span>
<span class="s2">            with linebreak&quot;&#39;, &#39;NULL&#39;, &#39;quote&#39;&#39;s here&#39;, </span><span class="si">{b}</span><span class="s2">, </span><span class="si">{h}</span><span class="s2">, </span><span class="si">{s1}</span><span class="s2">, </span><span class="si">{s2}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="n">sql_csv_testdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">teststring</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">b</span><span class="o">=</span><span class="n">enc_b64data</span><span class="p">,</span>
                <span class="n">h</span><span class="o">=</span><span class="n">enc_hexdata</span><span class="p">,</span>
                <span class="n">s1</span><span class="o">=</span><span class="n">sql_quote_string</span><span class="p">(</span><span class="n">not_enc_1</span><span class="p">),</span>
                <span class="n">s2</span><span class="o">=</span><span class="n">sql_quote_string</span><span class="p">(</span><span class="n">not_enc_2</span><span class="p">),</span>
            <span class="p">):</span> <span class="p">[</span>
                <span class="s2">&quot;one&quot;</span><span class="p">,</span>
                <span class="s2">&quot;two&quot;</span><span class="p">,</span>
                <span class="mi">3</span><span class="p">,</span>
                <span class="mf">4.5</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;hello &quot;hi</span><span class="se">\n</span><span class="s1">            with linebreak&quot;&#39;</span><span class="p">,</span>
                <span class="s2">&quot;NULL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;quote&#39;s here&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">data</span><span class="p">,</span>
                <span class="n">not_enc_1</span><span class="p">,</span>
                <span class="n">not_enc_2</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sql_csv_testdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">decode_values</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s2">&quot;Mismatch! Result: </span><span class="si">{r!s}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="s2">&quot;Should have been: </span><span class="si">{v!s}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="s2">&quot;Key was: </span><span class="si">{k!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">))</span>

        <span class="c1"># Newline encoding/decodine</span>
        <span class="n">ts2</span> <span class="o">=</span> <span class="s2">&quot;slash </span><span class="se">\\</span><span class="s2"> newline </span><span class="se">\n</span><span class="s2"> ctrl_r </span><span class="se">\r</span><span class="s2"> special </span><span class="se">\\</span><span class="s2">n other special </span><span class="se">\\</span><span class="s2">r &quot;</span> \
              <span class="s2">&quot;quote &#39; doublequote </span><span class="se">\&quot;</span><span class="s2"> &quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">unescape_newlines</span><span class="p">(</span><span class="n">escape_newlines</span><span class="p">(</span><span class="n">ts2</span><span class="p">)),</span> <span class="n">ts2</span><span class="p">,</span>
                         <span class="s2">&quot;Bug in escape_newlines() or unescape_newlines()&quot;</span><span class="p">)</span>

        <span class="c1"># TODO: more tests here... ?</span>

    <span class="k">def</span> <span class="nf">test_client_api_antique_support_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span><span class="s2">&quot;test_client_api_antique_support_1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">fake_request_post_from_dict</span><span class="p">({</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">CAMCOPS_VERSION</span><span class="p">:</span> <span class="n">MINIMUM_TABLET_VERSION</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_device</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">OPERATION</span><span class="p">:</span> <span class="n">Operations</span><span class="o">.</span><span class="n">WHICH_KEYS_TO_SEND</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">:</span> <span class="n">DEVICE_STORED_VAR_TABLENAME_DEFUNCT</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_reply_dict_from_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">]</span> <span class="o">==</span> <span class="n">SUCCESS_CODE</span>

    <span class="k">def</span> <span class="nf">test_client_api_antique_support_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span><span class="s2">&quot;test_client_api_antique_support_2&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">fake_request_post_from_dict</span><span class="p">({</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">CAMCOPS_VERSION</span><span class="p">:</span> <span class="n">MINIMUM_TABLET_VERSION</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_device</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">OPERATION</span><span class="p">:</span> <span class="n">Operations</span><span class="o">.</span><span class="n">WHICH_KEYS_TO_SEND</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">:</span> <span class="s2">&quot;nonexistent_table&quot;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_reply_dict_from_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">]</span> <span class="o">==</span> <span class="n">FAILURE_CODE</span>

    <span class="k">def</span> <span class="nf">test_client_api_antique_support_3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span><span class="s2">&quot;test_client_api_antique_support_3&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">fake_request_post_from_dict</span><span class="p">({</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">CAMCOPS_VERSION</span><span class="p">:</span> <span class="n">MINIMUM_TABLET_VERSION</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">DEVICE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">other_device</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">OPERATION</span><span class="p">:</span> <span class="n">Operations</span><span class="o">.</span><span class="n">UPLOAD_TABLE</span><span class="p">,</span>
            <span class="n">TabletParam</span><span class="o">.</span><span class="n">TABLE</span><span class="p">:</span> <span class="n">DEVICE_STORED_VAR_TABLENAME_DEFUNCT</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">client_api</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">get_reply_dict_from_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">d</span><span class="p">[</span><span class="n">TabletParam</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">]</span> <span class="o">==</span> <span class="n">SUCCESS_CODE</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># main</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># run with &quot;python -m camcops_server.cc_modules.client_api -v&quot; to be verbose</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main_only_quicksetup_rootlogger</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/download.html">2. Downloading CamCOPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_installation.html">3. Installing and configuring the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_using.html">4. Using the client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_general.html">5. Web site: general use</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_by_category.html">6. Tasks in CamCOPS by category</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tasks/_tasks_all.html">7. All tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client/client_troubleshooting.html">8. Troubleshooting client problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_installation.html">9. Installing CamCOPS on the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_configuration.html">10. Configuring the server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_config_file.html">11. The CamCOPS server configuration file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_front_end_admin.html">12. Web site: admin functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_command_line.html">13. CamCOPS command-line tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../server/server_troubleshooting.html">14. Troubleshooting server problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licences/licences.html">15. Licences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index.html">16. Developer notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">17. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/linux_flavours.html">18. Linux flavours</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/_index.html">19. Automatic documentation of core server source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">20. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_problems.html">21. Known problems: client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../known_problems.html#known-problems-server">22. Known problems: server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">23. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../wishlist.html">24. Wishlist and blue-sky thoughts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/local_info.html">25. Local configuration information</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CamCOPS 2.2.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2012-2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>