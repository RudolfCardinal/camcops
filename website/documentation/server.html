<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
  <meta name="generator" content=
  "HTML Tidy for Linux (vers 25 March 2009), see www.w3.org">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <!--#include virtual="/camcops/ssi/camcops_html_head.shtml" -->

  <title>CamCOPS – Server</title>
</head>

<body onload="generateTOC(document.getElementById('toc'));">
  <!--#set var="HEADER_TITLE" value="CamCOPS – Server" -->
  <!--#set var="HEADER_URL" value="documentation/server.html" -->
  <!--#set var="HEADER_BACK_URL" value="index.html" -->
  <!--#set var="HEADER_BACK_LABEL" value="Documentation" -->
  <!--#include virtual="/camcops/ssi/camcops_page_header.shtml" -->

  <div id="toc"></div>

  <h1>Your CamCOPS server</h1>

  <ul>
    <li>CamCOPS will operate offline on your tablet, and you can view simple
    summaries of your tasks there.</li>

    <li>You should set up a server to receive data from your CamCOPS tablet(s).

      <ul>
        <li>The simplest way (involving only free software) is to set up a
        <a href="http://en.wikipedia.org/wiki/Linux">Linux</a> (e.g. <a href=
        "http://www.ubuntu.com/">Ubuntu</a>) computer with an <a href=
        "http://httpd.apache.org/">Apache</a> web server and a <a href=
        "http://www.mysql.com/">MySQL</a> database (plus the Python
        interpreter, which comes with most Linux distributions) – collectively
        known as a <a href=
        "http://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP</a> stack.
        Alternative (e.g. Windows) configurations are possible, but we’ve not
        used them so do not provide details here.</li>

        <li>You must also obtain an <a href=
        "http://en.wikipedia.org/wiki/HTTP_Secure">HTTPS</a> certificate (or
        <a href=
        "http://www.akadia.com/services/ssh_test_certificate.html">create one
        for free</a> – not recommended), and configure your web server to do
        all its CamCOPS work via HTTPS only (not HTTP), so that your
        information is always encrypted in transit from the tablets to your
        server. The CamCOPS tablet app will not use unencrypted links. (Under
        Ubuntu, certificates live within <code>/etc/ssl</code>; under CentOS,
        they live under <code>/etc/pki/tls</code>).</li>

        <li>Then, CamCOPS provides scripts so your web server can receive data
        from your tablets, and offers a web front end so you can view your
        tasks in HTML and PDF format.</li>

        <li>For more advanced analysis, you can use the MySQL database
        directly.</li>

        <li>You must also consider the server’s security carefully; see
        <a href="security.html">Security</a>.</li>
      </ul>
    </li>

    <li>Having set up your server, you should point your tablet(s) to it (see
    <a href="tablet.html">configuring the tablet application</a>).</li>
  </ul>

  <h1>Configuring the server</h1>

  <h2>Overview</h2>
  <img alt="Block diagram of CamCOPS server" src="../images/server_diagram.png">

  <h2>Configure your firewall</h2>

  <div>
    Ensure your firewall is configured properly:

    <ul>
      <li>You’ll need to allow HTTPS through, for tablet communications and the
      web viewer. (The default port is 443. It’s possible to use another, but
      it will confuse users.)</li>

      <li>You’ll probably want remote SSH access, either through the default
      port (22), or a secret port known only to you.</li>

      <li>Other ports are up to you. If you want to run a plain web server as
      well, that’ll normally be on port 80. Access to CamCOPS should only be
      via HTTPS, not plain HTTP.</li>

      <li>Disable access to everything you don’t need.</li>
    </ul>
  </div>

  <h2>Install CamCOPS and its dependencies</h2>

  <h3>Summary of relevant Linux distribution differences</h3>
  <table>
    <tr>
      <th></th>
      <th>Ubuntu</th>
      <th>CentOS 6.5</th>
    </tr>
    <tr>
      <td><b><i>System</i></b></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>Heritage</td>
      <td>Debian</td>
      <td>Red Hat Enterprise Linux</td>
    </tr>
    <tr>
      <td>Package management</td>
      <td><code>apt-get</code>, <code>dpkg</code>, and for convenience <code>gdebi</code></td>
      <td><code>yum</code></td>
    </tr>
    <tr>
      <td>General system update</td>
      <td><code>sudo apt-get update && sudo apt-get dist-upgrade</code></td>
      <td><code>sudo yum update</code></td>
    </tr>
    <tr>
      <td>Package type</td>
      <td><code>deb</code></td>
      <td><code>rpm</code></td>
    </tr>
    <tr>
      <td>Extra security</td>
      <td>Nothing complex by default</td>
      <td>SELinux; <b>file permissions must be set with <code>chcon</code></b></td>
    </tr>
    <tr>
      <td><b><i>Python</i></b></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>Default Python versions <b>(CamCOPS requires 3.4)</b></td>
      <td>2.7, 3.4</td>
      <td>2.6</td>
    </tr>
    <tr>
      <td><b><i>Apache</i></b></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>Apache main configuration file</td>
      <td>Usually <code>/etc/apache2/apache2.conf</code></td>
      <td>Usually <code>/etc/httpd/conf/httpd.conf</code></td>
    </tr>
    <tr>
      <td>Apache SSL configuration file</td>
      <td>Usually <code>/etc/apache2/sites-available/default-ssl</code></td>
      <td>Usually <code>/etc/httpd/conf.d/ssl.conf</code></td>
    </tr>
    <tr>
      <td>Default Apache system user</td>
      <td><code>www-data</code></td>
      <td><code>apache</code></td>
    </tr>
    <tr>
      <td>Default SSL certificate location</td>
      <td><code>/etc/ssl/</code></td>
      <td><code>/etc/pki/tls/</code></td>
    </tr>
    <tr>
      <td>Default Apache log directory</td>
      <td><code>/var/log/apache2/</code></td>
      <td><code>/var/log/httpd/</code></td>
    </tr>
    <tr>
      <td>Restarting Apache</td>
      <td><code>sudo service apache2 [start|stop|restart]</code><br><code>sudo apache2ctl [start|stop|restart]</code><br><code>sudo apachectl [start|stop|restart]</code></td>
      <td><code>sudo service httpd [start|stop|restart]</code><br><code>sudo apachectl [start|stop|restart]</code></td>
    </tr>
    <tr>
      <td><b><i>MySQL</i></b></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>Default MySQL configuration file</td>
      <td><code>/etc/mysql/my.cnf</code></td>
      <td><code>/etc/my.cnf</code></td>
    </tr>
    <tr>
      <td>Restarting MySQL</td>
      <td><code>sudo service mysql [start|stop|restart]</code></td>
      <td><code>sudo service mysql<b>d</b> [start|stop|restart]</code></td>
    </tr>
    <tr>
      <td>Default MySQL log</td>
      <td><code>/var/log/mysql.log</code></td>
      <td><code>/var/log/mysql<b>d</b>.log</code></td>
    </tr>
    <tr>
      <td><b><i>CamCOPS packages</i></b></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td>Installation</td>
      <td><code>sudo gdebi install camcops_<i>VERSION</i>_all.deb</code></td>
      <td><code>sudo yum install camcops_<i>VERSION</i>.noarch.rpm</code></td>
    </tr>
    <tr>
      <td>Removal</td>
      <td><code>sudo dpkg --remove camcops</code></td>
      <td><code>sudo yum remove camcops</code></td>
    </tr>
  </table>

  <h3>Ubuntu 12.04 (a Debian-based Linux)</h3>

  <div>
    <ol>
      <li>Install Apache and MySQL. (As part of the MySQL installation, you
      will create a root database user. Remember the password!)
      <pre class="code1">
<b>sudo apt-get install apache2 mysql-client mysql-server</b></pre></li>

      <li><a href="../download/index.html">Download</a> the Debian package,
      which will be called <code>camcops_<i>VERSION</i>_all.deb</code>, where
      <i>VERSION</i> is the current version number.</li>

      <li>Install the packages and its dependencies:
        <pre class="code1">
<b>sudo gdebi camcops_</b><i>VERSION</i><b>_all.deb</b>
</pre>(If you don’t have <code>gdebi</code>, install it with <code>sudo apt-get
install gdebi</code>.)
      CamCOPS will now be installed in <code>/usr/share/camcops</code>.
      </li>
    </ol>
  </div>

  <h3>CentOS 6.5 (an RPM-based Linux)</h3>

  <div>
    <p>CamCOPS is designed for Debian Linux, so the installation procedure is
    much simpler there. Frankly, achieving this on CentOS 6.5 is fiddly; try
    to get a Ubuntu server. Nevertheless, it can be done:</p>

    <ol>
      <li>Ensure additional repositories are in use:
        <pre class="code1">
# RPMForge: see <a href=
"http://www.tecmint.com/install-and-enable-rpmforge-repository-in-rhel-centos-6-5-4/">http://www.tecmint.com/install-and-enable-rpmforge-repository-in-rhel-centos-6-5-4/</a>
# Use "cat /etc/centos-release" to see CentOS version; use "uname -a" to detect 32-bit/64-bit version.
# For example, for 64-bit CentOS 6.5:

<b>sudo rpm -Uvh http://packages.sw.be/rpmforge-release/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm</b>

# EPEL: see <a href=
"http://fedoraproject.org/wiki/EPEL">http://fedoraproject.org/wiki/EPEL</a>
# For example:

<b>sudo rpm -Uvh https://anorien.csc.warwick.ac.uk/mirrors/epel/6/i386/epel-release-6-8.noarch.rpm</b>

# Something providing Python 3 in package form (see <a href="http://stackoverflow.com/questions/8087184/installing-python3-on-rhel">http://stackoverflow.com/questions/8087184</a>):
<b>sudo yum install https://centos6.iuscommunity.org/ius-release.rpm</b>

# We need MySQL 5.5: <a href="http://www.webtatic.com/packages/mysql55/">http://www.webtatic.com/packages/mysql55/</a>
<b>sudo rpm -Uvh http://mirror.webtatic.com/yum/el6/latest.rpm</b>
</pre>
      </li>

      <li>Potential prerequisites for what follows:
        <pre class="code1"><b>sudo yum install blas-devel lapack-devel libffi-devel libpng-devel links nano openssl-devel python-devel</b></pre>
      </li>

      <li>Install Python 3.4 (which comes with pip and setuptools).
      <i>Note: CentOS 6.5 (December 2013) provides Python 2.6 (2009).
      You can’t just replace it, because its system scripts need Python 2.6.
      CentOS is based on Red Hat Enterprise Linux.
      Fedora 14 (another Red Hat derivative) moved to Python 2.7 in 2010.
      CamCOPS needs Python 3 (e.g. 3.4).</i>
      <pre class="code1">
<b>sudo yum install python34u</b>

# Test:
<b>python3 --version
pip3 --version</b>
</pre>
      </li>

      <li>Install MySQL:
      <pre class="code1">
<b>sudo yum install mysql55 mysql55-server mysql-devel</b></pre></li>

      <li>Install Apache:
      <pre class="code1">
<b>sudo yum install httpd httpd-devel mod_ssl</b></pre></li>

      <li><a href="../download/index.html">Download</a> the CamCOPS RPM
      package. This will be called
      <code>camcops-<i>VERSION</i>.noarch.rpm</code>, where <i>VERSION</i> is
      the current version number.</li>

      <li>Install the package (which will automatically install its
      dependencies):
      <pre class="code1">
<b>sudo yum install camcops_</b><i>VERSION</i><b>.noarch.rpm</b>

# Or, for more verbosity and to say yes to everything, use this command instead:
# <b>sudo yum --assumeyes --verbose --rpmverbosity=debug install camcops_</b><i>VERSION</i><b>.noarch.rpm</b>
# ... but, curiously, yum temporarily swallows the output from the post-install
#     scripts and only spits it out at the end. This makes it look like the
#     installation has got stuck (because packages like numpy are very slow
#     to install); use <b>watch pstree</b> or <b>top</b> to reassure yourself
#     that progress is indeed happening.
</pre>
      <b>Recognizing success:</b> if you type <code>camcops</code>, see an
      announcement of the CamCOPS version, and get asked for a configuration
      filename, CamCOPS is running happily from the command line.</li>

    </ol>
  </div>

  <h2>Set up MySQL and create a database ready for CamCOPS to use</h2>

  <div>
    <ol>
      <li>
        <b>Under Ubuntu, if you are happy to leave the data files at their
        default location, skip this step.</b> Check/edit the MySQL
        configuration (see table above for filenames). See <a href=
        "http://dev.mysql.com/tech-resources/articles/mysql_intro.html">Getting
        Started with MySQL</a>. In particular:

        <ul>
          <li><code>datadir</code> should point to your database files (default
          often <code>/var/lib/mysql</code>, but <code>/srv/mysql</code> is one
          alternative).</li>

          <li>Other options are explained <a href=
          "http://dev.mysql.com/doc/mysql/en/server-system-variables.html">here</a>.</li>

          <li>If you create a blank directory (such as
          <code>/srv/mysql</code>), you will need to use the
          <code>mysql_install_db</code> tool; see <a href=
          "http://dev.mysql.com/doc/refman/5.7/en/postinstallation.html">Postinstallation
          Setup and Testing</a>; an example is <code>sudo mysql_install_db
          --user=mysql --basedir=/usr --datadir=/srv/mysql</code></li>

          <li>Manual start: <code>sudo /usr/bin/mysqld_safe --user=mysql
          &amp;</code>. Manual stop: <code>sudo mysqladmin
          shutdown</code>.</li>

          <li>Service start/stop: see table above.</li>

          <li>If it starts manually but not as a service (in a manner that
          depends on your data directory), you have a challenging problem; an
          option is to return to the default data directory!</li>

          <li>To log in prior to securing the database:
          <code>mysql</code>.</li>

          <li><a href=
          "http://centoshelp.org/servers/database/installing-configuring-mysql-server/">
          CentOS MySQL installation guide</a>.</li>

          <li>Default logfile: <code>/var/log/mysqld.log</code> or
          <code>/var/log/mysql/...</code></li>
        </ul>
      </li>

      <li>Secure your MySQL installation by running
      <code>mysql_secure_installation</code>.

        <ul>
          <li>Login after securing: <code>mysql -u root -p</code>.</li>

          <li>Similar username/password requirements now apply to manual
          shutdowns.</li>
        </ul>
      </li>

      <li>
        <b>Ensure that the <code>max_allowed_packet</code> parameter is large
        enough.</b>
        <ul>
          <li>This parameter needs to be set large enough that the
          largest binary large objects (BLOBs) can be uploaded. CamCOPS BLOBs
          are mostly photographs from tablets. A high-end tablet in 2014 might
          have an 8 megapixel (MP) camera, with each pixel taking 3 bytes, i.e.
          24 Mb. Furthermore, the transfer takes more space thanks to somewhat
          inefficient encoding. The
          <a href="http://dev.mysql.com/doc/refman/5.7/en/packet-too-large.html">
          MySQL server default value</a> is just 1 Mb.</li>

          <li>You must set this parameter for the server, and for the
          <code>mysqldump</code> tool.</li>

          <li>A suggested value is 32 Mb. Edit <code>my.cnf</code> to include
          <code>max_allowed_packet</code> values the <code>[mysqld]</code>
          and <code>[mysqldump]</code> sections (creating them if necessary).

          <li>Similar editing of the <code>[client]</code> section of
          <code>my.cnf</code> is unnecessary, firstly because some
          other MySQL clients may not recognize the option and
          <a href="http://dev.mysql.com/doc/refman/5.0/en/option-files.html">
          might choke</a> on it, and secondly because CamCOPS uses
          <a href="http://mysql-python.sourceforge.net/">MySQLdb
          (MySQL-Python)</a>, which uses the MySQL C API, which has a
          <a href="http://dev.mysql.com/doc/refman/5.7/en/c-api.html">default
          limit of 1 Gb</a>.</li>

        </ul>
      </li>

      <li>Set some other MySQL parameters for TEXT-heavy tables; see
      <a href="faq_bugs.html">FAQs/bugs</a>.</li>

      <li>
        Thus, edit <code>my.cnf</code> to include the following:
        <pre class="code1">[mysqld]
max_allowed_packet = 32M

innodb_strict_mode = 1
innodb_file_per_table = 1
innodb_file_format = Barracuda

# Only for MySQL prior to 5.7.5 (http://dev.mysql.com/doc/relnotes/mysql/5.6/en/news-5-6-20.html):
# innodb_log_file_size = 512M

[mysqldump]
max_allowed_packet = 32M</pre>
      </li>

      <li>Ensure MySQL is running as a service (as above).</li>

      <li>
        <b>Create the CamCOPS database.</b> Log in to MySQL using the root user
        details you created earlier, and follow these commands (which you’ll
        find at <code>/usr/share/camcops/demo_mysql_database_creation</code>):
        <pre class="code1"><!--#include virtual="demo_mysql_database_creation" --></pre>
      </li>

      <li>Ensure MySQL restarts on boot. On Ubuntu, this should be automatic.
      On CentOS, run <code>sudo chkconfig --level 2345 mysqld on</code>. To
      check, run <code>sudo chkconfig --list | grep mysqld</code></li>
    </ol>
  </div>

  <h2>Configure CamCOPS</h2>

  <div>
    <p>Edit (or copy and edit) <code>/etc/camcops/camcops.conf</code>,
    specifying (at the least) your database username/password and your local
    institution’s URL. There are a sequence of <code><i>parameter</i> =
    <i>value</i></code> lines, mostly under the section heading
    <code>[server]</code>. A sample configuration file is:</p>
    <pre class="code1"><!--#include virtual="camcops.conf" --></pre>
  </div>

  <h2>Use the CamCOPS command-line tool to create tables and a superuser</h2>
  <div>
    <p>Run the CamCOPS command-line tool. The tool will need read access to the
    configuration file (which should be readable only by the Apache user and
    root). So you might do:</p>
    <pre class="code1"><b>sudo camcops</b> [configfile]</pre>

    <ul>
      <li>... or on a Ubuntu/Debian system, where the Apache user is probably
      called <code>www-data</code>, you could use <code>sudo -u www-data
      camcops [configfile]</code>;</li>

      <li>... or on a Ubuntu/Debian system, where the Apache user is probably
      called <code>apache</code> (defined in the Apache configuration file via
      the User and Group directives): <code>sudo -u apache camcops
      [configfile]</code>.</li>
    </ul>

    <p>If you didn’t provide the filename of the configuration file, CamCOPS
    will ask you for it. Enter the name of the configuration you just
    edited, e.g. <code>/etc/camcops/camcops.conf</code>. Now:</p>

    <ul>
      <li>Create the tables (and specify the default ID descriptions) using the
      menu provided.</li>

      <li>Create your superuser using the menu provided. The superuser creation
      process should finish by saying <code>Success: True</code>. If it says
      <code>Success: False</code>, then that user probably exists already.</li>
    </ul>

    <p>You can also perform configuration tasks from the command line. Type</p>
    <pre class="code1"><b>camcops --help</b></pre>

    <p>for details.</p>
  </div>

  <h2>Configure Apache or other front-end web server</h2>

  <div>
    <ol>
      <li>Add sections to the HTTPS (SSL) site file (see table above),
      which is referred to by the main Apache configuration file (see table
      above).
      You should read the instructions at
      <code>/usr/share/camcops/instructions.txt</code>, reproduced below.
      <pre class="code1"><!--#include virtual="instructions.txt" --></pre>
      </li>

      <li>Ensure file ownerships/permissions are correct (including, on CentOS,
      SELinux permissions: see <a href=
      "http://wiki.apache.org/httpd/13PermissionDenied">13PermissionDenied</a>
      and <a href=
      "https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Managing_Confined_Services/chap-Managing_Confined_Services-The_Apache_HTTP_Server.html">
        Apache and SELinux</a>). On Ubuntu, if you use <code>/srv/www</code> as
        your DocumentRoot, you may need to do:
        <pre class="code1">
sudo chown -R www-data:www-data /srv/www
</pre>On CentOS, assuming you use <code>/var/www</code> as your DocumentRoot,
you may need to do:
        <pre class="code1">
ls -alZ /var/www # shows owners and SELinux security context

sudo chown -R apache:apache /var/www
sudo chcon -R -h system_u:object_r:httpd_sys_content_t /var/www
sudo chown -R apache:apache /etc/camcops
sudo chcon -R -h system_u:object_r:httpd_sys_content_t /etc/camcops
</pre>
      </li>

      <li>Restart Apache: <code>sudo apachectl restart</code>.</li>

      <li>Ensure Apache restarts on boot. On Ubuntu, this should be automatic.
      On CentOS, run <code>sudo chkconfig --level 2345 httpd on</code></li>
    </ol>
  </div>

  <h2>Test tablet and web access</h2>

  <div>
    <p>Test the webview by browsing to the webview URL you configured, by
    default <code>https://<b>YOURHOST</b>/camcops/webview</code>. Log in with
    the username and password you chose.</p>

    <p>Try with <code>http://</code> instead, and verify that this fails (you
    shouldn’t allow access to the CamCOPS server via plain HTTP).</p>

    <p>Test the tablet access by pointing your CamCOPS tablet to the tablet URL
    (by default <code>https://<b>YOURHOST</b>/camcops/database</code>) using a
    username and password that you have created, registering the tablet, and
    uploading some data.</p>
  </div>

  <h2>Configure backups</h2>

  <div>
    <p>Your backup strategy is up to you. However, one option is to use a
    script to dump all MySQL databases. A sample script is in
    <code>/usr/share/camcops/demo_mysql_dump_script</code>, reproduced below.
    You will need to
    copy this and edit the copy. <b>Be sure your copy of the script is readable
    only by root, as it contains a password.</b> You can then run your script
    regularly from <code>/etc/crontab</code>.</p>

    <pre class="code1"><!--#include virtual="demo_mysql_dump_script" --></pre>

    <p>Obviously, you will also need the dumped files to be backed up to a
    physically secure location regularly.</p>
  </div>

  <h1><a name="multiple_instances" id="multiple_instances"></a>More than one
  CamCOPS instance</h1>

  <div>
    <p>This is simple to do. You will need to:</p>

    <ul>
      <li>Create a second CamCOPS database (from the MySQL command line) as
      above. <b>Be careful:</b> MySQL users are system-wide. So don’t think you
      can have a user named camcopsmaster with password X for one database, and
      a user named camcopmaster with password Y for another database;
      attempting this will merely change the password for that (single)
      user.</li>

      <li>Create a second CamCOPS configuration file, e.g. copying
      <code>/etc/camcops/camcops.conf</code> to
      <code>/etc/camcops/<b>camcops2</b>.conf</code> and editing it to point to
      the new database.</li>

      <li>Run <code>camcops</code> from the command line, pointing it to the
      new configuration file, to create the tables and a superuser.</li>

      <li>Add a second instance to the Apache configuration file (see the
      commented-out example in the demonstration Apache configuration file) and
      restart Apache.</li>
    </ul>
  </div>

  <h1>Performance tuning</h1>

  <h2>MySQL/InnoDB commit</h2>

  <div>
    <p>Network latency can be considerably improved by altering the
    MySQL/InnoDB log-on-commit behaviour. This is governed by the
    <code>innodb_flush_log_at_trx_commit</code> variable. The default is
    <code>1</code>, which is the safest; it is required for <a href=
    "http://en.wikipedia.org/wiki/ACID">ACID compliance</a>. However, setting
    it to <code>2</code> makes database write operations much faster.</p>

    <p>This can by done by editing the MySQL configuration file (see table
    above) to add the line <code>innodb_flush_log_at_trx_commit = 2</code>
    in the <code>[mysqld]</code> section, after which you would
    need to restart MySQL (see commands in table above), or
    changed dynamically at the MySQL command line with <code>SET GLOBAL
    innodb_flush_log_at_trx_commit = 2;</code>. Use <code>SHOW
    VARIABLES;</code> to show the current values.</p>

    <p>See <a href=
    "http://stackoverflow.com/questions/14121464/mysql-is-slow-with-innodb-during-insert-compared-to-myisam">
    discussion</a>, <a href=
    "http://dev.mysql.com/doc/refman/5.5/en/innodb-parameters.html">reference</a>.</p>
  </div>

  <h1>Uninstalling CamCOPS</h1>

  <div>
    <p>Remove prior to any upgrade. See table above for commands.</p>
  </div>

  <h1>Upgrading CamCOPS</h1>

  <div>
    <ol>
      <li>Stop the web server (see table above).</li>

      <li>Uninstall CamCOPS, as above.</li>

      <li>Reinstall from the new package (see table above), e.g.
      <code>sudo gdebi install
      camcops_<i>NEWVERSION</i>_all.deb</code> or <code>sudo yum install
      camcops_<i>NEWVERSION</i>.noarch.rpm</code>.</li>

      <li>For every configuration file, re-make the tables (in case new tables
      have been added): <code>sudo camcops -m
      /etc/camcops/<i>myconfigfile</i></code>.
        <ul>
          <li>If you have lots, you can use the <code>camcops_meta.py</code>
          tool, like this: <code>sudo camcops_meta --filespecs
          /etc/camcops/<b>SOMEFILESPEC</b> --ccargs maketables</code></li>
        </ul>
      </li>

      <li>Restart Apache (see table above).</li>
    </ol>
  </div>

  <h1>Troubleshooting</h1>

  <div>
    <ul>
      <li><b>Web server returns “permission denied”-type messages; Apache error
      log is full of file permission errors.</b> Ownerships, permissions, or
      SELinux security settings on files in the <code>DocumentRoot</code> tree
      are probably wrong. See above.</li>

      <li><b>Web server returns nothing informative; Apache error log is full
      WSGI messages relating to its inability to create socket files.</b> See
      above regarding <code>WSGISocketPrefix</code>.</li>

      <li><b>Web server returns nothing informative; Apache error log is full
      of messages saying “import site failed”.</b> The <code>mod_wsgi</code>
      configuration is probably wrong. Run the <code>ldd</code> check above and
      reinstall <code>mod_wsgi</code> if necessary.</li>

      <li><b>Operation (e.g. table upload) fails; Apache error log contains the
      message “client denied by server configuration”.</b> The Apache
      configuration file might be missing a section saying
<pre>
&lt;Directory /usr/share/camcops/server&gt;
    # ...
    &lt;Files "database.py"&gt; # CGI script for tablets to upload data
        Allow from all
    &lt;/Files&gt;
    # ...
&lt;/Directory&gt;</pre>
      </li>

      <li><b>Web server returns content but says &lt;class
      'ConfigParser.NoSectionError'&gt;: No section: 'server'</b>. This
      probably means that the <code>/etc/camcops/*</code> configuration files
      have the wrong ownerships/permissions/SELinux security settings. See the
      <code>chown</code> and <code>chcon</code> commands above. It’s also
      possible that the configuration files have been damaged, or that the
      Apache configuration file is pointing to a non-existing configuration
      file.</li>

      <li><b>I can log in, but then seem to be logged out again
      immediately.</b> Is your browser correctly storing session cookies?
      Especially, are you trying to run CamCOPS over a non-encrypted (HTTP)
      link? The session cookies are set to <code>secure</code> and
      <code>httponly</code> for security reasons, and will not work without
      HTTPS.</li>

      <li><b>SSL not working; Apache log contains “Invalid method in request
      \x16\x03\x01”.</b> Misconfigured server; it is <a href=
      "http://www.noah.org/wiki/Apache2_Invalid_method_in_request_%5Cx16%5Cx03%5Cx01">
      speaking unencrypted HTTP on port 443</a>. Do you have the
      <code>VirtualHost</code> section configured properly? Do you have
      <code>LoadModule ssl_module modules/mod_ssl.so</code>?</li>

      <li><b>Tablet uploads fails with error including “(2006, 'MySQL server
      has gone away')”. Apache log contains “OperationalError: (2006, 'MySQL
      server has gone away')”.</b> CamCOPS takes care to ping the database
      connection, so it’s unlikely that a connection has timed out. The
      probable cause is that the relevant <code>max_allowed_packet</code>
      parameter is set too small; MySQL also
      <a href="http://dev.mysql.com/doc/refman/5.7/en/gone-away.html">generates
      this error if the query is too big.</a> You will need to edit the MySQL
      <code>my.cnf</code> configuration file; see above. The most probable time
      to see this error is when uploading the BLOB table (<code>blobs</code>).
      </li>

      <li><b>Tablet BLOB upload fails with error “Read timed out”.</b>
      Likely problem: large BLOB (big photo), slow network. For example, in
      one of our tests a BLOB took more than 17 s to upload, so the tablet
      needs to wait at least that long after starting to send it. Increase the
      tablet’s network timeout (e.g. try increasing from 5000 to 60000 ms)
      in Settings → Server settings.</li>

      <li><b>Server will not regenerate summary tables and complains about
      being unable to open lockfile.</b> This probably reflects system
      permissions, particularly with SELinux. Try:
      <pre class="code1">
sudo chown -R apache:apache /var/lock/camcops
sudo chcon -R -h system_u:object_r:httpd_sys_content_t /var/lock/camcops</pre></li>

      <li><b>Other Apache errors.</b> See
      <code>/usr/share/camcops/instructions.txt</code>, which has specimen
      Apache config sections, and lists some other common misconfiguration
      errors.</li>

    </ul>
  </div><!--#include virtual="/camcops/ssi/camcops_footer.shtml" -->
</body>
</html>
